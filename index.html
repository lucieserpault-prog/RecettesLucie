<!doctype html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Ton carnet</title>
  <style>
    :root{
      --bg:#0b0f17;
      --paper:rgba(18,24,38,.62);
      --paper2:rgba(18,24,38,.82);
      --ink:#eef2ff;
      --muted:rgba(238,242,255,.74);
      --line:rgba(255,255,255,.10);
      --shadow:0 18px 60px rgba(0,0,0,.45);
      --shadow2:0 10px 30px rgba(0,0,0,.35);
      --accent:#b7a1ff;
      --ok:#63e6b0;
      --warn:#ffd36b;
      --danger:#ff6b7a;
      --r:22px;
      --r2:18px;
      --max:1200px;
      --sans: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial;
    }
    body.light{
      --bg:#f6f7fb;
      --paper:#ffffff;
      --paper2:#ffffff;
      --ink:#121826;
      --muted:#5b6477;
      --line:#e7e9f1;
      --shadow:0 12px 36px rgba(16,24,40,.10);
      --shadow2:0 6px 18px rgba(16,24,40,.08);
      --accent:#6d5efc;
      --ok:#22c55e;
      --warn:#f59e0b;
      --danger:#ef4444;
    }
    *{box-sizing:border-box}
    body{
      margin:0; font-family:var(--sans); color:var(--ink);
      background:
        radial-gradient(1000px 620px at 15% 0%, rgba(183,161,255,.25), transparent 60%),
        radial-gradient(900px 560px at 90% 10%, rgba(255,211,107,.14), transparent 58%),
        radial-gradient(800px 520px at 60% 100%, rgba(99,230,176,.14), transparent 55%),
        linear-gradient(180deg, var(--bg), #070a10);
      min-height:100vh;
    }
    a{color:inherit}
    .wrap{max-width:var(--max); margin:0 auto; padding:18px 14px 40px;}
    header{
      display:flex; align-items:center; justify-content:space-between; gap:12px;
      padding:12px 14px; margin:12px auto 16px;
      border:1px solid var(--line);
      border-radius:var(--r);
      background:var(--paper);
      box-shadow:var(--shadow);
      backdrop-filter: blur(14px); -webkit-backdrop-filter: blur(14px);
    }
    .brand{display:flex; gap:12px; align-items:center}
    .logo{
      width:40px; height:40px; border-radius:14px;
      background: linear-gradient(135deg, rgba(183,161,255,.75), rgba(99,230,176,.55));
      box-shadow:0 16px 40px rgba(0,0,0,.30);
    }
    h1{font-size:18px; margin:0; letter-spacing:.2px}
    .sub{font-size:12px; color:var(--muted); margin-top:2px}
    .actions{display:flex; gap:10px; flex-wrap:wrap; justify-content:flex-end}
    .btn{
      appearance:none; border:1px solid var(--line);
      background:rgba(255,255,255,.06);
      color:var(--ink);
      padding:10px 12px;
      border-radius:14px;
      font-weight:850;
      cursor:pointer;
      box-shadow:var(--shadow2);
      transition: transform .08s ease, background .2s ease, border-color .2s ease;
      backdrop-filter: blur(10px); -webkit-backdrop-filter: blur(10px);
    }
    .btn:hover{transform: translateY(-1px); border-color: rgba(255,255,255,.20)}
    .btn.primary{
      background: rgba(183,161,255,.18);
      border-color: rgba(183,161,255,.22);
    }
    .btn.ok{background: rgba(99,230,176,.18); border-color: rgba(99,230,176,.22);}
    .btn.danger{background: rgba(255,107,122,.18); border-color: rgba(255,107,122,.22);}
    .btn.ghost{background: transparent; box-shadow:none}
    .row{display:flex; gap:10px; align-items:center; flex-wrap:wrap}
    .card{
      border:1px solid var(--line);
      border-radius:var(--r);
      background:var(--paper);
      box-shadow:var(--shadow);
      padding:16px;
      backdrop-filter: blur(14px); -webkit-backdrop-filter: blur(14px);
    }
    .toolbar{
      display:grid;
      grid-template-columns: 1.4fr .8fr .8fr .8fr .8fr;
      gap:10px;
      align-items:end;
      margin-bottom:14px;
    }
    @media(max-width: 980px){
      .toolbar{grid-template-columns: 1fr 1fr 1fr; }
    }
    @media(max-width: 640px){
      .toolbar{grid-template-columns: 1fr; }
    }
    label{font-size:12px; color:var(--muted); font-weight:850; display:block; margin:0 0 6px}
    input, select, textarea{
      width:100%;
      border:1px solid var(--line);
      background:rgba(255,255,255,.06);
      color:var(--ink);
      border-radius:14px;
      padding:11px 12px;
      outline:none;
    }
    textarea{min-height:110px; resize:vertical}
    .pill{
      display:inline-flex; gap:6px; align-items:center;
      border:1px solid var(--line);
      background:rgba(255,255,255,.06);
      padding:4px 8px;
      border-radius:999px;
      font-size:12px;
      font-weight:850;
      color:var(--ink);
      white-space:nowrap;
    }
    .pill.accent{background: rgba(183,161,255,.18); border-color: rgba(183,161,255,.22);}
    .pill.ok{background: rgba(99,230,176,.18); border-color: rgba(99,230,176,.22);}
    .pill.warn{background: rgba(255,211,107,.18); border-color: rgba(255,211,107,.22);}
    .pill.danger{background: rgba(255,107,122,.18); border-color: rgba(255,107,122,.22);}
    .mini{font-size:12px; color:var(--muted); line-height:1.35}
    .grid{
      column-count:3;
      column-gap:14px;
    }
    @media(max-width: 980px){.grid{column-count:2}}
    @media(max-width: 620px){.grid{column-count:1}}
    .rcard{
      break-inside:avoid;
      margin:0 0 14px;
      border:1px solid var(--line);
      border-radius:var(--r);
      background:var(--paper2);
      box-shadow:var(--shadow2);
      overflow:hidden;
      cursor:pointer;
      backdrop-filter: blur(14px); -webkit-backdrop-filter: blur(14px);
    }
    .thumb{
      height:260px;
      background: rgba(255,255,255,.06);
      position:relative;
      display:flex; align-items:center; justify-content:center;
      color:rgba(255,255,255,.65);
      font-weight:900;
      letter-spacing:.2px;
    }
    .thumb img{width:100%; height:100%; object-fit:cover; display:block}
    .thumb:after{
      content:""; position:absolute; inset:0;
      background: linear-gradient(180deg, rgba(0,0,0,0) 38%, rgba(0,0,0,.78) 100%);
      pointer-events:none;
    }
    .rcard .body{
      position:relative;
      margin-top:-86px;
      padding:14px 14px 16px;
      color:#fff;
    }
    .rcard .name{margin:0; font-size:16px; font-weight:950; text-shadow: 0 8px 24px rgba(0,0,0,.65)}
    .rcard .meta{margin-top:6px; font-size:12px; color: rgba(255,255,255,.80)}
    .rcard .pills{margin-top:10px; display:flex; flex-wrap:wrap; gap:8px}
    .modal{
      width:min(980px, calc(100vw - 18px));
      max-height: calc(100vh - 18px);
      overflow:auto;
      border:1px solid var(--line);
      background:var(--paper2);
      border-radius:var(--r);
      box-shadow:var(--shadow);
      backdrop-filter: blur(16px); -webkit-backdrop-filter: blur(16px);
    }
    .overlay{
      position:fixed; inset:0;
      background: rgba(0,0,0,.55);
      display:none;
      align-items:center; justify-content:center;
      padding:10px;
      z-index:50;
    }
    .mh{
      padding:12px 14px;
      display:flex; align-items:center; justify-content:space-between; gap:10px;
      border-bottom:1px solid var(--line);
      position:sticky; top:0;
      background: linear-gradient(180deg, rgba(18,24,38,.95), rgba(18,24,38,.70));
      backdrop-filter: blur(14px);
    }
    body.light .mh{
      background: linear-gradient(180deg, rgba(255,255,255,.95), rgba(255,255,255,.75));
    }
    .mt{font-weight:950}
    .mb{padding:14px}
    .two{
      display:grid; grid-template-columns: 1.1fr .9fr; gap:12px;
    }
    @media(max-width: 900px){.two{grid-template-columns:1fr}}
    table{width:100%; border-collapse:collapse; overflow:hidden; border-radius:16px}
    th,td{padding:10px 10px; border-bottom:1px solid var(--line); vertical-align:top}
    th{font-size:12px; color:var(--muted); text-align:left; font-weight:900}
    .right{display:flex; gap:10px; align-items:center; justify-content:flex-end; flex-wrap:wrap}
    .div{height:1px; background:var(--line); margin:12px 0}
    .imgBox{
      border:1px dashed var(--line);
      border-radius:18px;
      background: rgba(255,255,255,.06);
      height:220px;
      display:flex; align-items:center; justify-content:center;
      overflow:hidden;
      color:var(--muted);
      font-weight:900;
    }
    .imgBox img{width:100%; height:100%; object-fit:cover}
    .toast{
      position:fixed; left:50%; bottom:18px; transform:translateX(-50%);
      background: rgba(18,24,38,.90);
      border:1px solid var(--line);
      color:var(--ink);
      padding:10px 12px;
      border-radius:14px;
      box-shadow:var(--shadow2);
      display:none;
      z-index:60;
      font-weight:900;
    }
    body.light .toast{background: rgba(255,255,255,.92); color: var(--ink)}
    .kbd{border:1px solid var(--line); background:rgba(255,255,255,.08); border-radius:10px; padding:2px 8px; font-weight:950;}
  </style>
</head>
<body>
  <div class="wrap">
    <header>
      <div class="brand">
        <div class="logo"></div>
        <div>
          <h1>Ton carnet</h1>
          <div class="sub">Recettes ‚Ä¢ macros ‚Ä¢ listes de courses ‚Äî vibe Pinterest chic</div>
        </div>
      </div>
      <div class="actions">
        <button class="btn" id="btnTheme" title="Th√®me">üåô</button>
        <button class="btn" id="btnNew">‚ûï Nouvelle recette</button>
        <button class="btn" id="btnImport">üìÑ Import Word</button>
        <button class="btn" id="btnFoods">ü•ó Aliments</button>
      </div>
    </header>

    <div class="card">
      <div class="toolbar">
        <div>
          <label>Recherche</label>
          <input id="q" placeholder="ex: brownie, tofu, citron, 450 kcal..." />
        </div>
        <div>
          <label>Cat√©gorie</label>
          <select id="mainCat">
            <option value="">Toutes</option>
            <option>Healthy</option>
            <option>Gourmand</option>
          </select>
        </div>
        <div>
          <label>Sous-cat√©gorie</label>
          <select id="subCat">
            <option value="">Toutes</option>
            <option>Entr√©e</option>
            <option>Plat</option>
            <option>Dessert</option>
            <option>Bakery</option>
          </select>
        </div>
        <div>
          <label>Trier</label>
          <select id="sort">
            <option value="updated">R√©cents</option>
            <option value="name">Nom</option>
            <option value="kcal">Calories</option>
            <option value="protein">Prot√©ines</option>
          </select>
        </div>
        <div class="right">
          <button class="btn ghost" id="btnClear">‚Ü∫ Reset</button>
        </div>
      </div>
      <div class="mini" id="countLine"></div>
    </div>

    <div style="height:14px"></div>
    <div id="grid" class="grid"></div>
  </div>

  <div class="toast" id="toast"></div>

  <!-- Recipe view -->
  <div class="overlay" id="ovView">
    <div class="modal">
      <div class="mh">
        <div class="mt" id="viewTitle">Recette</div>
        <div class="right">
          <button class="btn ok" id="btnShop">üõí Liste de course</button>
          <button class="btn" id="btnEdit">‚úèÔ∏è Modifier</button>
          <button class="btn danger" id="btnDelete">üóëÔ∏è Supprimer</button>
          <button class="btn" id="btnCloseView">‚úï</button>
        </div>
      </div>
      <div class="mb" id="viewBody"></div>
    </div>
  </div>

  <!-- Recipe form -->
  <div class="overlay" id="ovForm">
    <div class="modal">
      <div class="mh">
        <div class="mt" id="formTitle">Nouvelle recette</div>
        <div class="right">
          <button class="btn primary" id="btnSave">Enregistrer</button>
          <button class="btn" id="btnCloseForm">‚úï</button>
        </div>
      </div>
      <div class="mb">
        <div class="two">
          <div class="card" style="background:transparent; box-shadow:none">
            <div class="row" style="gap:12px">
              <div style="flex:1">
                <label>Nom</label>
                <input id="fName" />
              </div>
              <div style="width:160px">
                <label>Cat√©gorie</label>
                <select id="fMain">
                  <option>Healthy</option>
                  <option>Gourmand</option>
                </select>
              </div>
              <div style="width:160px">
                <label>Sous-cat√©gorie</label>
                <select id="fSub">
                  <option>Entr√©e</option>
                  <option>Plat</option>
                  <option>Dessert</option>
                  <option>Bakery</option>
                </select>
              </div>
            </div>

            <div style="height:10px"></div>

            <div class="row" style="gap:12px">
              <div style="width:170px">
                <label>Difficult√©</label>
                <select id="fDiff">
                  <option>Facile</option>
                  <option>Moyen</option>
                  <option>Difficile</option>
                </select>
              </div>
              <div style="width:170px">
                <label>Temps (min)</label>
                <input id="fTime" type="number" min="0" step="1" value="0"/>
              </div>
              <div style="width:170px">
                <label>Portions</label>
                <input id="fServ" type="number" min="1" step="1" value="1"/>
              </div>
              <div style="flex:1" class="row" title="Si activ√©, les macros sont calcul√©es √† partir des ingr√©dients">
                <label style="margin:0">Auto macros</label>
                <input id="fAuto" type="checkbox" checked style="width:auto; transform:scale(1.15)"/>
              </div>
            </div>

            <div class="div"></div>
            <div class="row" style="justify-content:space-between; align-items:end">
              <div>
                <div class="mini"><strong>Ingr√©dients</strong> ‚Äî quantit√© libre (ex: <span class="kbd">1/2 pomme</span>) + grammes (pour macros)</div>
              </div>
              <div class="right">
                <button class="btn" id="btnAddIng" type="button">+ Ajouter</button>
              </div>
            </div>
            <div style="height:10px"></div>
            <div style="overflow:auto">
              <table>
                <thead><tr><th>Aliment</th><th>Quantit√©</th><th>g</th><th>Label (option)</th><th>Note</th><th></th></tr></thead>
                <tbody id="ingBody"></tbody>
              </table>
            </div>

            <div class="div"></div>

            <div class="two" style="grid-template-columns:1fr 1fr; gap:12px">
              <div>
                <label>Instructions</label>
                <textarea id="fSteps" placeholder="√âtapes‚Ä¶"></textarea>
              </div>
              <div>
                <label>Notes</label>
                <textarea id="fNotes" placeholder="Astuces, variantes‚Ä¶"></textarea>
              </div>
            </div>
          </div>

          <div class="card" style="background:transparent; box-shadow:none">
            <div class="mini"><strong>Photo</strong></div>
            <div class="imgBox" id="fImgBox"><span>Ajouter une photo</span></div>
            <div class="right" style="margin-top:10px">
              <input type="file" id="fPhoto" accept="image/*"/>
              <button class="btn" id="btnRemovePhoto" type="button">Retirer</button>
            </div>

            <div class="div"></div>
            <div class="mini"><strong>Macros</strong></div>
            <div class="row" style="margin-top:10px; gap:10px">
              <div class="pill warn" id="mKcal">üî• 0 kcal</div>
              <div class="pill ok" id="mP">üí™ 0 g P</div>
              <div class="pill" id="mC">üçû 0 g G</div>
              <div class="pill" id="mF">ü•ë 0 g L</div>
            </div>
            <div class="mini" style="margin-top:10px">Les macros sont bas√©es sur les grammes renseign√©s (100g = valeurs base aliments).</div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Import -->
  <div class="overlay" id="ovImport">
    <div class="modal" style="max-width:980px">
      <div class="mh">
        <div class="mt">Import Word / texte</div>
        <div class="right">
          <button class="btn primary" id="btnPreviewImport">Pr√©visualiser</button>
          <button class="btn ok" id="btnDoImport">Importer</button>
          <button class="btn" id="btnCloseImport">‚úï</button>
        </div>
      </div>
      <div class="mb">
        <div class="mini">Format attendu :</div>
        <div class="mini" style="margin-top:6px">
          <span class="kbd">nom: ‚Ä¶</span><br>
          <span class="kbd">ingr√©dients:</span> (une ligne par ingr√©dient, ex: <span class="kbd">120 g riz cuit</span> ou <span class="kbd">1/2 pomme</span>)<br>
          <span class="kbd">instructions:</span>
        </div>
        <div style="height:10px"></div>
        <label>Colle ton texte</label>
        <textarea id="importText"></textarea>

        <div class="div"></div>
        <div class="mini"><strong>Photo (option)</strong></div>
        <div class="imgBox" id="importImgBox"><span>Ajouter une photo</span></div>
        <div class="right" style="margin-top:10px">
          <input type="file" id="importPhoto" accept="image/*"/>
          <button class="btn" id="btnRemoveImportPhoto" type="button">Retirer</button>
        </div>

        <div class="div"></div>
        <div class="mini" id="importInfo"></div>
      </div>
    </div>
  </div>

  <!-- Validate ingredients -->
  <div class="overlay" id="ovValidate">
    <div class="modal">
      <div class="mh">
        <div class="mt">Valider les ingr√©dients</div>
        <div class="right">
          <button class="btn primary" id="btnConfirmImport">Ajouter la recette</button>
          <button class="btn" id="btnCloseValidate">‚úï</button>
        </div>
      </div>
      <div class="mb">
        <div class="mini" id="validateSummary"></div>
        <div class="div"></div>
        <div style="overflow:auto">
          <table>
            <thead><tr><th>Texte import√©</th><th>Quantit√©</th><th>Aliment choisi</th><th>Note</th></tr></thead>
            <tbody id="validateBody"></tbody>
          </table>
        </div>
      </div>
    </div>
  </div>

  <!-- Foods -->
  <div class="overlay" id="ovFoods">
    <div class="modal">
      <div class="mh">
        <div class="mt">Biblioth√®que aliments</div>
        <div class="right">
          <button class="btn" id="btnAddFood" type="button">+ Ajouter aliment</button>
          <button class="btn" id="btnCloseFoods">‚úï</button>
        </div>
      </div>
      <div class="mb">
        <div class="toolbar" style="grid-template-columns: 1.3fr .7fr .7fr .7fr .6fr;">
          <div>
            <label>Recherche</label>
            <input id="foodsQ" placeholder="ex: tofu (cru), riz cuit..." />
          </div>
          <div>
            <label>√âtat</label>
            <select id="foodsState">
              <option value="">Tous</option>
              <option>Cru</option>
              <option>Cuit</option>
              <option>Surgel√©</option>
              <option>Conserve</option>
            </select>
          </div>
          <div class="right" style="align-items:end">
            <button class="btn ghost" id="btnFoodsReset" type="button">‚Ü∫ Reset</button>
          </div>
          <div class="right" style="align-items:end">
            <div class="mini" id="foodsCount"></div>
          </div>
          <div></div>
        </div>
        <div style="overflow:auto">
          <table>
            <thead><tr><th>Aliment</th><th>kcal</th><th>P</th><th>G</th><th>L</th></tr></thead>
            <tbody id="foodsBody"></tbody>
          </table>
        </div>
      </div>
    </div>
  </div>

  <!-- Ambiguity chooser -->
  <div class="overlay" id="ovAmb">
    <div class="modal" style="max-width:560px">
      <div class="mh">
        <div class="mt">Choisir l‚Äôaliment</div>
        <div class="right">
          <button class="btn" id="btnCloseAmb">‚úï</button>
        </div>
      </div>
      <div class="mb">
        <div class="mini" id="ambText"></div>
        <div class="div"></div>
        <div id="ambOptions" style="display:flex; flex-direction:column; gap:10px"></div>
      </div>
    </div>
  </div>

  <!-- Shopping list -->
  <div class="overlay" id="ovShop">
    <div class="modal" style="max-width:720px">
      <div class="mh">
        <div class="mt">Liste de course</div>
        <div class="right">
          <button class="btn" id="btnCopyShop">Copier</button>
          <button class="btn" id="btnCloseShop">‚úï</button>
        </div>
      </div>
      <div class="mb">
        <div class="mini">Bas√©e sur la recette ouverte (agr√©gation par aliment).</div>
        <div class="div"></div>
        <textarea id="shopText" style="min-height:260px"></textarea>
      </div>
    </div>
  </div>

<script>
  // ---------- helpers ----------
  function $(sel){ return document.querySelector(sel); }
  function $all(sel){ return Array.from(document.querySelectorAll(sel)); }
  function safeOn(sel, ev, fn){ const el = $(sel); if(!el) return; el.addEventListener(ev, fn); }
  function uid(){ return Math.random().toString(16).slice(2) + Date.now().toString(16); }
  function escapeHtml(s){ return (s??"").toString().replace(/[&<>"']/g, m=>({ "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#039;" }[m])); }
  function normalize(s){ return (s||"").toLowerCase()
    .normalize("NFD").replace(/[\u0300-\u036f]/g,"")
    .replace(/[^a-z0-9\s]/g," ").replace(/\s+/g," ").trim(); }
  function fmt1(n){ return Math.round((Number(n)||0)*10)/10; }
  function showToast(msg){
    const t=$("#toast"); t.textContent=msg; t.style.display="block";
    clearTimeout(window.__tt); window.__tt=setTimeout(()=>t.style.display="none", 1800);
  }

  // ---------- theme ----------
  function isLight(){ return localStorage.getItem("theme")==="light"; }
  function applyTheme(){
    document.body.classList.toggle("light", isLight());
    $("#btnTheme").textContent = isLight() ? "‚òÄÔ∏è" : "üåô";
  }
  safeOn("#btnTheme","click",()=>{
    localStorage.setItem("theme", isLight() ? "dark" : "light");
    applyTheme();
  });
  applyTheme();

  // ---------- data ----------
  const STATE_KEY="ton_carnet_state_v1";
  const FOODS_KEY="ton_carnet_foods_v1";

  // small-but-solid starter foods (you can grow it later)
  const DEFAULT_FOODS=[
    // Proteins
    {id:"poulet_cru", name:"Poulet (cru)", kcal:120, p:23, c:0, f:2},
    {id:"poulet_cuit", name:"Poulet (cuit)", kcal:165, p:31, c:0, f:3.6},
    {id:"thon", name:"Thon (conserve, √©goutt√©)", kcal:132, p:29, c:0, f:1},
    {id:"oeuf", name:"≈íuf entier (cru)", kcal:143, p:13, c:1.1, f:10},
    {id:"tofu", name:"Tofu nature (cru)", kcal:120, p:13, c:2, f:7},
    {id:"tempeh", name:"Tempeh", kcal:192, p:20, c:9, f:11},
    {id:"skyr", name:"Skyr 0%", kcal:57, p:10, c:3.6, f:0.2},
    // Carbs
    {id:"riz_cuit", name:"Riz (cuit)", kcal:130, p:2.4, c:28.6, f:0.3},
    {id:"pates_cuites", name:"P√¢tes (cuites)", kcal:158, p:5.8, c:30.9, f:0.9},
    {id:"quinoa_cuit", name:"Quinoa (cuit)", kcal:120, p:4.4, c:21.3, f:1.9},
    {id:"avoine", name:"Flocons d'avoine (crus)", kcal:389, p:17, c:66, f:7},
    {id:"pain", name:"Pain", kcal:265, p:9, c:49, f:3.2},
    {id:"pdt_cuite", name:"Pomme de terre (cuite)", kcal:87, p:2, c:20, f:0.1},
    // Veg
    {id:"brocoli_cru", name:"Brocoli (cru)", kcal:34, p:2.8, c:6.6, f:0.4},
    {id:"brocoli_cuit", name:"Brocoli (cuit)", kcal:35, p:2.4, c:7.2, f:0.4},
    {id:"epinard", name:"√âpinards (crus)", kcal:23, p:2.9, c:3.6, f:0.4},
    {id:"tomate", name:"Tomate (crue)", kcal:18, p:0.9, c:3.9, f:0.2},
    {id:"courgette", name:"Courgette (crue)", kcal:17, p:1.2, c:3.1, f:0.3},
    {id:"carotte", name:"Carotte (crue)", kcal:41, p:0.9, c:9.6, f:0.2},
    {id:"salade", name:"Salade verte (crue)", kcal:15, p:1.4, c:2.9, f:0.2},
    // Fruit
    {id:"pomme", name:"Pomme (crue)", kcal:52, p:0.3, c:14, f:0.2},
    {id:"banane", name:"Banane (crue)", kcal:89, p:1.1, c:23, f:0.3},
    {id:"fraise", name:"Fraise (crue)", kcal:32, p:0.7, c:7.7, f:0.3},
    // Fats
    {id:"huile_olive", name:"Huile d'olive", kcal:884, p:0, c:0, f:100},
    {id:"beurre_cacahuete", name:"Beurre de cacahu√®te", kcal:588, p:25, c:20, f:50},
    {id:"amande", name:"Amandes", kcal:579, p:21, c:22, f:50},
    // Dairy alternatives
    {id:"lait_amande", name:"Lait d'amande (sans sucre)", kcal:13, p:0.4, c:0.3, f:1.1},
    {id:"yaourt_soja", name:"Yaourt soja nature", kcal:54, p:4.1, c:2.8, f:2.7},
  ];

  const UNIT_GRAMS=[
    {re:/\boeuf\b|\boeufs\b/i, grams:60, label:"1 oeuf"},
    {re:/\bpomme de terre\b|\bpatate\b/i, grams:170, label:"1 pomme de terre"},
    {re:/\bpomme\b/i, grams:150, label:"1 pomme"},
    {re:/\bbanane\b/i, grams:120, label:"1 banane"},
    {re:/\boignon\b/i, grams:110, label:"1 oignon"},
    {re:/\bcarotte\b/i, grams:70, label:"1 carotte"},
    {re:/\byaourt\b|\byahourt\b/i, grams:125, label:"1 yaourt"},
  ];
  function fractionToFloat(s){
    s=(s||"").trim(); if(!s) return null;
    if(/^[0-9]+\s*\/\s*[0-9]+$/.test(s)){
      const [a,b]=s.split("/").map(x=>parseFloat(x.trim()));
      if(b) return a/b;
    }
    const f=parseFloat(s.replace(",","."));
    return isNaN(f)?null:f;
  }
  function guessUnitGrams(name){
    for(const u of UNIT_GRAMS){ if(u.re.test(name||"")) return u.grams; }
    return null;
  }

  function inferState(name){
    const n=normalize(name);
    if(n.includes(" cru") || n.includes("(cru)")) return "Cru";
    if(n.includes(" cuit") || n.includes("(cuit)") || n.includes(" cuite")) return "Cuit";
    if(n.includes("surgele") || n.includes("(surgele)")) return "Surgel√©";
    if(n.includes("conserve") || n.includes("(en conserve)")) return "Conserve";
    return "";
  }

  function loadFoods(){
    try{
      const raw=localStorage.getItem(FOODS_KEY);
      if(!raw) return DEFAULT_FOODS.slice();
      const parsed=JSON.parse(raw);
      return Array.isArray(parsed) ? parsed : DEFAULT_FOODS.slice();
    }catch{ return DEFAULT_FOODS.slice(); }
  }
  function saveFoods(){ localStorage.setItem(FOODS_KEY, JSON.stringify(foods)); }

  function loadState(){
    try{
      const raw=localStorage.getItem(STATE_KEY);
      if(!raw) return {recipes:[]};
      const st=JSON.parse(raw);
      if(!st || !Array.isArray(st.recipes)) return {recipes:[]};
      return st;
    }catch{ return {recipes:[]}; }
  }
  function saveState(){ localStorage.setItem(STATE_KEY, JSON.stringify(state)); }

  let foods = loadFoods();
  let state = loadState();
  let currentId = null;
  let formId = null;
  let formPhotoData = null;
  let importPhotoData = null;
  let pendingImport = null;

  function foodById(id){ return foods.find(f=>f.id===id) || null; }
  function foodName(id){ const f=foodById(id); return f?f.name:""; }

  // ---------- matching ----------
  function bestFoodMatches(query, limit=6){
    const q=normalize(query);
    if(!q) return [];
    const tokens=q.split(" ").filter(Boolean);
    const scored = foods.map(f=>{
      const n=normalize(f.name);
      let score=0;
      if(n===q) score+=120;
      if(n.includes(q)) score+=70;
      for(const t of tokens){
        if(n.includes(t)) score+=18;
      }
      // small bonus for same state keyword
      const qs = inferState(query), fs = inferState(f.name);
      if(qs && fs && qs===fs) score+=8;
      return {f, score};
    }).filter(x=>x.score>0).sort((a,b)=>b.score-a.score).slice(0, limit);
    return scored.map(x=>({f:x.f, s:x.score}));
  }

  // ambiguity modal
  let ambResolve=null;
  function chooseAmbiguous(matches, original){
    return new Promise((resolve)=>{
      ambResolve=resolve;
      $("#ambText").innerHTML = `Plusieurs choix pour : <span class="kbd">${escapeHtml(original)}</span>`;
      const box=$("#ambOptions"); box.innerHTML="";
      matches.forEach(m=>{
        const st=inferState(m.f.name) || "‚Äî";
        const btn=document.createElement("button");
        btn.className="btn primary";
        btn.style.textAlign="left";
        btn.innerHTML = `<div style="font-weight:950">${escapeHtml(m.f.name)}</div>
                         <div class="mini" style="margin-top:4px">√âtat: <strong>${escapeHtml(st)}</strong> ‚Ä¢ score ${Math.round(m.s)}</div>`;
        btn.onclick=()=>{ $("#ovAmb").style.display="none"; resolve(m.f); };
        box.appendChild(btn);
      });
      $("#ovAmb").style.display="flex";
    });
  }
  safeOn("#btnCloseAmb","click",()=>{
    $("#ovAmb").style.display="none";
    if(ambResolve) ambResolve(null);
  });
  safeOn("#ovAmb","click",(e)=>{
    if(e.target && e.target.id==="ovAmb"){
      $("#ovAmb").style.display="none";
      if(ambResolve) ambResolve(null);
    }
  });

  // ---------- render recipes ----------
  function recipeCardHTML(r){
    const img = r.photo ? `<img src="${r.photo}" alt="${escapeHtml(r.name)}">` : "";
    const thumb = `<div class="thumb">${img || escapeHtml(r.mainCat||"Recette")}</div>`;
    const pills = [
      `<span class="pill accent">${escapeHtml(r.mainCat||"‚Äî")}</span>`,
      `<span class="pill">${escapeHtml(r.subCat||"‚Äî")}</span>`,
      `<span class="pill">‚è± ${Number(r.timeMin||0)} min</span>`,
      `<span class="pill warn">‚≠ê ${escapeHtml(r.difficulty||"‚Äî")}</span>`,
      `<span class="pill">üî• ${Math.round(r.kcal||0)} kcal</span>`,
      `<span class="pill ok">üí™ ${fmt1(r.p||0)} g P</span>`,
    ].join(" ");
    return `<div class="rcard" data-id="${r.id}">
      ${thumb}
      <div class="body">
        <h3 class="name">${escapeHtml(r.name||"Sans titre")}</h3>
        <div class="meta">${escapeHtml((r.notes||"").slice(0,92))}${(r.notes||"").length>92?"‚Ä¶":""}</div>
        <div class="pills">${pills}</div>
      </div>
    </div>`;
  }

  function filteredRecipes(){
    const q=normalize($("#q").value);
    const mc=$("#mainCat").value;
    const sc=$("#subCat").value;
    const sort=$("#sort").value;

    let list = state.recipes.slice();
    if(mc) list=list.filter(r=>(r.mainCat||"")===mc);
    if(sc) list=list.filter(r=>(r.subCat||"")===sc);
    if(q){
      list=list.filter(r=>{
        const hay = normalize((r.name||"")+" "+(r.notes||"")+" "+(r.steps||""));
        if(hay.includes(q)) return true;
        // ingredient names
        const ing = (r.ingredients||[]).map(i=>normalize(foodName(i.foodId)||i.label||"")).join(" ");
        return ing.includes(q);
      });
    }

    if(sort==="name") list.sort((a,b)=>(a.name||"").localeCompare((b.name||""),"fr"));
    if(sort==="kcal") list.sort((a,b)=>(Number(b.kcal||0)-Number(a.kcal||0)));
    if(sort==="protein") list.sort((a,b)=>(Number(b.p||0)-Number(a.p||0)));
    if(sort==="updated") list.sort((a,b)=>(Number(b.updatedAt||0)-Number(a.updatedAt||0)));
    return list;
  }

  function renderRecipes(){
    const list = filteredRecipes();
    $("#grid").innerHTML = list.length ? list.map(recipeCardHTML).join("") : `<div class="card"><div class="mini">Aucune recette. Clique sur <strong>‚ûï Nouvelle recette</strong> ou <strong>üìÑ Import Word</strong>.</div></div>`;
    $("#countLine").innerHTML = `Recettes : <strong>${list.length}</strong> ‚Ä¢ Base aliments : <strong>${foods.length}</strong>`;
    $all(".rcard").forEach(el=>{
      el.addEventListener("click",()=>openRecipe(el.getAttribute("data-id")));
    });
  }

  // ---------- macros ----------
  function calcTotals(ingredients){
    let kcal=0,p=0,c=0,f=0;
    for(const it of (ingredients||[])){
      const food = foodById(it.foodId);
      if(!food) continue;
      const g = Number(it.grams||0);
      if(!g) continue;
      const factor = g/100;
      kcal += (food.kcal||0)*factor;
      p += (food.p||0)*factor;
      c += (food.c||0)*factor;
      f += (food.f||0)*factor;
    }
    return {kcal,p,c,f};
  }

  // ---------- view recipe ----------
  function openRecipe(id){
    const r = state.recipes.find(x=>x.id===id);
    if(!r) return;
    currentId = id;
    $("#viewTitle").textContent = r.name || "Recette";
    const img = r.photo ? `<div class="imgBox" style="height:320px; margin-bottom:12px"><img src="${r.photo}"></div>` : "";
    const topPills = `
      <div class="row" style="gap:8px; margin-bottom:10px">
        <span class="pill accent">${escapeHtml(r.mainCat||"‚Äî")}</span>
        <span class="pill">${escapeHtml(r.subCat||"‚Äî")}</span>
        <span class="pill">‚è± ${Number(r.timeMin||0)} min</span>
        <span class="pill warn">‚≠ê ${escapeHtml(r.difficulty||"‚Äî")}</span>
        <span class="pill">üçΩÔ∏è ${Number(r.servings||1)} portion(s)</span>
      </div>
      <div class="row" style="gap:8px; margin-bottom:12px">
        <span class="pill warn">üî• ${Math.round(r.kcal||0)} kcal</span>
        <span class="pill ok">üí™ ${fmt1(r.p||0)} g P</span>
        <span class="pill">üçû ${fmt1(r.c||0)} g G</span>
        <span class="pill">ü•ë ${fmt1(r.f||0)} g L</span>
      </div>
    `;

    const rows = (r.ingredients||[]).map(it=>{
      const f=foodById(it.foodId);
      const nm = it.label || (f?f.name:"Aliment manquant");
      const qty = (it.qtyText && it.qtyText.trim()) ? it.qtyText : (it.grams? (it.grams+" g") : "");
      return `<tr>
        <td><strong>${escapeHtml(nm)}</strong><div class="mini">${f?escapeHtml(f.name):""}</div></td>
        <td>${escapeHtml(qty)}<div class="mini">${escapeHtml(it.grams!=null? (it.grams+" g"):"‚Äî")}</div></td>
        <td>${escapeHtml(it.note||"")}</td>
      </tr>`;
    }).join("");

    const ingTable = `
      <div class="card" style="background:transparent; box-shadow:none">
        <div class="mini"><strong>Ingr√©dients</strong></div>
        <div style="height:8px"></div>
        <div style="overflow:auto">
          <table>
            <thead><tr><th>Ingr√©dient</th><th>Quantit√©</th><th>Note</th></tr></thead>
            <tbody>${rows || `<tr><td colspan="3" class="mini">‚Äî</td></tr>`}</tbody>
          </table>
        </div>
      </div>
    `;

    const steps = `
      <div class="card" style="background:transparent; box-shadow:none">
        <div class="mini"><strong>Instructions</strong></div>
        <div style="height:8px"></div>
        <div style="white-space:pre-wrap; line-height:1.5">${escapeHtml(r.steps||"") || '<span class="mini">‚Äî</span>'}</div>
      </div>
    `;
    const notes = `
      <div class="card" style="background:transparent; box-shadow:none">
        <div class="mini"><strong>Notes</strong></div>
        <div style="height:8px"></div>
        <div style="white-space:pre-wrap; line-height:1.5">${escapeHtml(r.notes||"") || '<span class="mini">‚Äî</span>'}</div>
      </div>
    `;

    $("#viewBody").innerHTML = img + topPills + `<div class="two">${ingTable}${steps}</div><div style="height:10px"></div>${notes}`;
    $("#ovView").style.display="flex";
  }

  function closeView(){ $("#ovView").style.display="none"; }
  safeOn("#btnCloseView","click",closeView);
  safeOn("#ovView","click",(e)=>{ if(e.target && e.target.id==="ovView") closeView(); });

  // delete
  safeOn("#btnDelete","click",()=>{
    if(!currentId) return;
    const r = state.recipes.find(x=>x.id===currentId);
    if(!r) return;
    if(!confirm(`Supprimer "${r.name}" ?`)) return;
    state.recipes = state.recipes.filter(x=>x.id!==currentId);
    saveState();
    closeView();
    renderRecipes();
    showToast("Supprim√© ‚úÖ");
  });

  // ---------- form ----------
  function resetForm(){
    formId=null;
    formPhotoData=null;
    $("#formTitle").textContent="Nouvelle recette";
    $("#fName").value="";
    $("#fMain").value="Healthy";
    $("#fSub").value="Plat";
    $("#fDiff").value="Facile";
    $("#fTime").value=0;
    $("#fServ").value=1;
    $("#fAuto").checked=true;
    $("#fSteps").value="";
    $("#fNotes").value="";
    $("#fPhoto").value="";
    $("#fImgBox").innerHTML="<span>Ajouter une photo</span>";
    $("#ingBody").innerHTML="";
    addIngRow();
    updateMacroPreview();
  }

  function addIngRow(ing={foodId: foods[0]?.id || "", grams: 0, qtyText:"", label:"", note:""}){
    const tr=document.createElement("tr");
    tr.innerHTML = `
      <td><select class="foodSel"></select></td>
      <td><input class="qtyText" type="text" placeholder="ex: 1/2 pomme" value="${escapeHtml(ing.qtyText||"")}"></td>
      <td><input class="grams" type="number" min="0" step="1" value="${escapeHtml(ing.grams||0)}"></td>
      <td><input class="label" type="text" value="${escapeHtml(ing.label||"")}"></td>
      <td><input class="note" type="text" value="${escapeHtml(ing.note||"")}"></td>
      <td><button class="btn danger" type="button">‚Äî</button></td>
    `;
    const sel = tr.querySelector(".foodSel");
    sel.innerHTML = foods.slice().sort((a,b)=>a.name.localeCompare(b.name,"fr"))
      .map(f=>`<option value="${escapeHtml(f.id)}">${escapeHtml(f.name)}</option>`).join("");
    sel.value = ing.foodId || foods[0]?.id || "";
    tr.querySelector("button").addEventListener("click",()=>{ tr.remove(); updateMacroPreview(); });
    tr.querySelectorAll("input,select").forEach(el=>el.addEventListener("input", updateMacroPreview));
    $("#ingBody").appendChild(tr);
  }

  function collectIngredients(){
    return [...$("#ingBody").querySelectorAll("tr")].map(tr=>({
      foodId: tr.querySelector(".foodSel").value,
      qtyText: (tr.querySelector(".qtyText").value||"").trim(),
      grams: Number(tr.querySelector(".grams").value||0),
      label: (tr.querySelector(".label").value||"").trim(),
      note: (tr.querySelector(".note").value||"").trim(),
    })).filter(i=>i.foodId && i.grams>0);
  }

  function updateMacroPreview(){
    const ingredients = collectIngredients();
    const t = calcTotals(ingredients);
    $("#mKcal").textContent = `üî• ${Math.round(t.kcal)} kcal`;
    $("#mP").textContent = `üí™ ${fmt1(t.p)} g P`;
    $("#mC").textContent = `üçû ${fmt1(t.c)} g G`;
    $("#mF").textContent = `ü•ë ${fmt1(t.f)} g L`;
  }

  safeOn("#btnAddIng","click",()=>addIngRow());
  safeOn("#btnNew","click",()=>{ resetForm(); $("#ovForm").style.display="flex"; });

  function closeForm(){ $("#ovForm").style.display="none"; }
  safeOn("#btnCloseForm","click",closeForm);
  safeOn("#ovForm","click",(e)=>{ if(e.target && e.target.id==="ovForm") closeForm(); });

  // photo in form
  safeOn("#fPhoto","change",(e)=>{
    const file=e.target.files?.[0]; if(!file) return;
    if(file.size>2.5*1024*1024){ alert("Photo trop lourde (max ~2,5MB)."); e.target.value=""; return; }
    const reader=new FileReader();
    reader.onload=()=>{ formPhotoData=reader.result; $("#fImgBox").innerHTML=`<img src="${formPhotoData}">`; };
    reader.readAsDataURL(file);
  });
  safeOn("#btnRemovePhoto","click",()=>{
    formPhotoData=null;
    $("#fPhoto").value="";
    $("#fImgBox").innerHTML="<span>Ajouter une photo</span>";
  });

  // edit current
  safeOn("#btnEdit","click",()=>{
    const r = state.recipes.find(x=>x.id===currentId);
    if(!r) return;
    closeView();
    formId = r.id;
    formPhotoData = r.photo || null;
    $("#formTitle").textContent="Modifier la recette";
    $("#fName").value=r.name||"";
    $("#fMain").value=r.mainCat||"Healthy";
    $("#fSub").value=r.subCat||"Plat";
    $("#fDiff").value=r.difficulty||"Facile";
    $("#fTime").value=Number(r.timeMin||0);
    $("#fServ").value=Number(r.servings||1);
    $("#fAuto").checked = !!r.autoMacros;
    $("#fSteps").value=r.steps||"";
    $("#fNotes").value=r.notes||"";
    $("#fImgBox").innerHTML = formPhotoData ? `<img src="${formPhotoData}">` : "<span>Ajouter une photo</span>";
    $("#fPhoto").value="";
    $("#ingBody").innerHTML="";
    (r.ingredients||[]).forEach(i=>addIngRow(i));
    if(!(r.ingredients||[]).length) addIngRow();
    updateMacroPreview();
    $("#ovForm").style.display="flex";
  });

  safeOn("#btnSave","click",()=>{
    const name=$("#fName").value.trim();
    if(!name){ alert("Ajoute un nom."); return; }
    const ingredients = collectIngredients();
    if(!ingredients.length){ alert("Ajoute au moins 1 ingr√©dient (avec grammes)."); return; }
    const rec = {
      id: formId || uid(),
      name,
      mainCat: $("#fMain").value,
      subCat: $("#fSub").value,
      difficulty: $("#fDiff").value,
      timeMin: Number($("#fTime").value||0),
      servings: Number($("#fServ").value||1),
      autoMacros: $("#fAuto").checked,
      photo: formPhotoData || null,
      ingredients,
      steps: $("#fSteps").value,
      notes: $("#fNotes").value,
      updatedAt: Date.now(),
      createdAt: formId ? (state.recipes.find(x=>x.id===formId)?.createdAt || Date.now()) : Date.now(),
    };
    if(rec.autoMacros){
      const t=calcTotals(rec.ingredients);
      rec.kcal=Math.round(t.kcal);
      rec.p=fmt1(t.p);
      rec.c=fmt1(t.c);
      rec.f=fmt1(t.f);
    }else{
      // keep previous if any, else compute anyway
      const t=calcTotals(rec.ingredients);
      rec.kcal=Math.round(t.kcal);
      rec.p=fmt1(t.p); rec.c=fmt1(t.c); rec.f=fmt1(t.f);
    }

    // upsert
    state.recipes = state.recipes.filter(x=>x.id!==rec.id);
    state.recipes.unshift(rec);
    saveState();
    closeForm();
    renderRecipes();
    showToast("Enregistr√© ‚úÖ");
    openRecipe(rec.id);
  });

  // ---------- filters wiring ----------
  ["#q","#mainCat","#subCat","#sort"].forEach(sel=>{
    safeOn(sel,"input",renderRecipes);
    safeOn(sel,"change",renderRecipes);
  });
  safeOn("#btnClear","click",()=>{
    $("#q").value=""; $("#mainCat").value=""; $("#subCat").value=""; $("#sort").value="updated";
    renderRecipes();
  });

  // ---------- foods modal ----------
  function renderFoods(){
    const q=normalize($("#foodsQ").value);
    const st=$("#foodsState").value;
    let list=foods.slice().sort((a,b)=>a.name.localeCompare(b.name,"fr"));
    if(q) list=list.filter(f=>normalize(f.name).includes(q));
    if(st) list=list.filter(f=>inferState(f.name)===st);
    $("#foodsCount").innerHTML = `<strong>${list.length}</strong> / ${foods.length}`;
    $("#foodsBody").innerHTML = list.map(f=>`<tr>
      <td><strong>${escapeHtml(f.name)}</strong><div class="mini">${escapeHtml(inferState(f.name)||"‚Äî")}</div></td>
      <td>${f.kcal}</td><td>${f.p}</td><td>${f.c}</td><td>${f.f}</td>
    </tr>`).join("");
  }

  function openFoods(){
    renderFoods();
    $("#ovFoods").style.display="flex";
  }
  function closeFoods(){ $("#ovFoods").style.display="none"; }
  safeOn("#btnFoods","click",openFoods);
  safeOn("#btnCloseFoods","click",closeFoods);
  safeOn("#ovFoods","click",(e)=>{ if(e.target && e.target.id==="ovFoods") closeFoods(); });
  safeOn("#foodsQ","input",renderFoods);
  safeOn("#foodsState","change",renderFoods);
  safeOn("#btnFoodsReset","click",()=>{ $("#foodsQ").value=""; $("#foodsState").value=""; renderFoods(); });

  safeOn("#btnAddFood","click",()=>{
    let name = prompt("Nom de l‚Äôaliment :");
    if(!name) return;
    const state = prompt("√âtat ? (cru / cuit / surgel√© / conserve) ‚Äî optionnel :", "cru") || "";
    const st = normalize(state);
    if(st && !normalize(name).includes("cru") && !normalize(name).includes("cuit") && !normalize(name).includes("surgele") && !normalize(name).includes("conserve")){
      if(st.includes("cru")) name += " (cru)";
      else if(st.includes("cuit")) name += " (cuit)";
      else if(st.includes("surg")) name += " (surgel√©)";
      else if(st.includes("cons")) name += " (en conserve)";
    }
    const kcal = Number(prompt("kcal pour 100g :", "0")||0);
    const p = Number(prompt("Prot√©ines (g/100g) :", "0")||0);
    const c = Number(prompt("Glucides (g/100g) :", "0")||0);
    const f = Number(prompt("Lipides (g/100g) :", "0")||0);
    foods.push({id:uid(), name, kcal, p, c, f});
    saveFoods();
    renderFoods();
    renderRecipes(); // refresh selectors in form rows maybe later
    showToast("Aliment ajout√© ‚úÖ");
  });

  // ---------- import parsing ----------
  function parseIngredientLine(line){
    const raw=(line||"").trim();
    if(!raw) return null;
    const s=raw.replace(/^[-‚Ä¢*\u2022\s]+/,"").trim();

    // grams / kg / ml / cl / l
    let m=s.match(/^([0-9]+(?:[\.,][0-9]+)?)\s*(kg|g|gr|grammes|grams|ml|cl|l)\b\s*(.*)$/i);
    if(m){
      const num=parseFloat(m[1].replace(",","."));
      const unit=m[2].toLowerCase();
      const name=(m[3]||"").trim();
      let grams=num;
      if(unit==="kg") grams=num*1000;
      else if(unit==="l") grams=num*1000;
      else if(unit==="cl") grams=num*10;
      else grams=num;
      return {name, grams:Math.round(grams*10)/10, qtyText:(m[1]+" "+m[2]).trim(), raw};
    }

    // fraction or count: "1/2 pomme", "2 pommes"
    m=s.match(/^([0-9]+\s*\/\s*[0-9]+|[0-9]+(?:[\.,][0-9]+)?)\s*(.*)$/);
    if(m){
      const qtyStr=m[1].replace(/\s+/g,"");
      const qty=fractionToFloat(qtyStr);
      const rest=(m[2]||"").trim();
      if(qty!=null && rest){
        const gramsEach=guessUnitGrams(rest);
        if(gramsEach){
          return {name:rest, grams:Math.round(qty*gramsEach), qtyText:qtyStr+" "+rest, raw};
        }
        return {name:rest, grams:null, qtyText:qtyStr+" "+rest, raw};
      }
    }

    // spoons
    m=s.match(/^([0-9]+)\s*(c\.\s*a\.\s*s|cas|cuillere\s*a\s*soupe|cuill√®re\s*√†\s*soupe)\s*(.*)$/i);
    if(m){
      const n=parseInt(m[1]||"1",10);
      const name=(m[3]||"").trim()||"Huile d'olive";
      const grams=normalize(name).includes("huile")?10*n:15*n;
      return {name, grams, qtyText:`${n} c√†s`, raw};
    }
    m=s.match(/^([0-9]+)\s*(c\.\s*a\.\s*c|cac|cuillere\s*a\s*cafe|cuill√®re\s*√†\s*caf√©)\s*(.*)$/i);
    if(m){
      const n=parseInt(m[1]||"1",10);
      const name=(m[3]||"").trim()||"Sucre";
      const grams=5*n;
      return {name, grams, qtyText:`${n} c√†c`, raw};
    }

    return {name:s, grams:null, qtyText:"", raw};
  }

  async function parseImportText(text){
    const t=(text||"").replace(/\r/g,"").trim();
    if(!t) return null;

    const nameMatch=t.match(/(?:^|\n)\s*(?:nom|title)\s*:\s*(.+)\s*(?:\n|$)/i);
    const name=nameMatch?nameMatch[1].trim():"Recette import√©e";

    const ingBlockMatch=t.match(/(?:^|\n)\s*(?:ingredients|ingr[e√©]dients)\s*:\s*([\s\S]*?)(?:\n\s*(?:instructions|preparation|pr√©paration|etapes|√©tapes)\s*:|$)/i);
    const instrMatch=t.match(/(?:^|\n)\s*(?:instructions|preparation|pr√©paration|etapes|√©tapes)\s*:\s*([\s\S]*)$/i);

    const ingBlock=ingBlockMatch?ingBlockMatch[1].trim():"";
    const instructions=instrMatch?instrMatch[1].trim():"";

    const lines=ingBlock.split("\n").map(x=>x.trim()).filter(Boolean);
    const parsed=lines.map(parseIngredientLine).filter(Boolean);

    const items=[];
    const unknown=[];

    for(const it of parsed){
      const nm=(it.name||"").trim();
      if(!nm){ unknown.push(it.raw); continue; }

      const matches = bestFoodMatches(nm, 6);
      if(!matches.length){
        unknown.push(it.raw);
        items.push({raw:it.raw, qtyText:it.qtyText||"", grams:it.grams, label:nm, matches:[], chosenId:"", note:"Non reconnu"});
        continue;
      }

      // If query is very generic and close matches exist, we'll still allow validation step
      const chosenId = matches[0].f.id;
      let grams = it.grams;
      let note = "";

      if(grams==null){
        const gEach = guessUnitGrams(nm);
        if(gEach){
          grams=gEach;
          note="Quantit√© estim√©e (unit√© ‚Üí grammes)";
        }else{
          grams=100;
          note="Quantit√© non trouv√©e ‚Üí 100g (√† ajuster)";
          unknown.push(it.raw+" (quantit√© manquante)");
        }
      }

      items.push({
        raw: it.raw,
        qtyText: it.qtyText||"",
        grams,
        label: nm,
        matches: matches.map(m=>({id:m.f.id, name:m.f.name, score:m.s})),
        chosenId,
        note
      });
    }

    return {name, items, instructions, unknown};
  }

  function openImport(){
    $("#importText").value="";
    $("#importInfo").textContent="";
    importPhotoData=null;
    $("#importPhoto").value="";
    $("#importImgBox").innerHTML="<span>Ajouter une photo</span>";
    $("#ovImport").style.display="flex";
  }
  function closeImport(){ $("#ovImport").style.display="none"; }
  safeOn("#btnImport","click",openImport);
  safeOn("#btnCloseImport","click",closeImport);
  safeOn("#ovImport","click",(e)=>{ if(e.target && e.target.id==="ovImport") closeImport(); });

  safeOn("#importPhoto","change",(e)=>{
    const file=e.target.files?.[0]; if(!file) return;
    if(file.size>2.5*1024*1024){ alert("Photo trop lourde (max ~2,5MB)."); e.target.value=""; return; }
    const reader=new FileReader();
    reader.onload=()=>{ importPhotoData=reader.result; $("#importImgBox").innerHTML=`<img src="${importPhotoData}">`; };
    reader.readAsDataURL(file);
  });
  safeOn("#btnRemoveImportPhoto","click",()=>{
    importPhotoData=null;
    $("#importPhoto").value="";
    $("#importImgBox").innerHTML="<span>Ajouter une photo</span>";
  });

  safeOn("#btnPreviewImport","click", async ()=>{
    const res = await parseImportText($("#importText").value);
    if(!res){ $("#importInfo").textContent="Colle une recette."; return; }
    const toFix = (res.unknown||[]).length;
    $("#importInfo").innerHTML = `Recette: <strong>${escapeHtml(res.name)}</strong> ‚Ä¢ Ingr√©dients: <strong>${res.items.length}</strong> ‚Ä¢ √Ä v√©rifier: <strong>${toFix}</strong>`;
  });

  function openValidate(res){
    pendingImport = res;
    const body=$("#validateBody");
    body.innerHTML="";
    let toCheck = (res.unknown||[]).length;

    res.items.forEach((it, idx)=>{
      const tr=document.createElement("tr");
      const qty = it.qtyText ? it.qtyText : (it.grams!=null ? (it.grams+" g") : "");
      const options = it.matches.length
        ? it.matches.map(m=>`<option value="${escapeHtml(m.id)}" ${m.id===it.chosenId?"selected":""}>${escapeHtml(m.name)} (score ${Math.round(m.score)})</option>`).join("")
        : `<option value="">‚Äî</option>`;
      if(!it.matches.length || /√† ajuster/i.test(it.note||"")) toCheck++;

      tr.innerHTML = `
        <td><strong>${escapeHtml(it.label)}</strong><div class="mini">${escapeHtml(it.raw)}</div></td>
        <td>${escapeHtml(qty)}<div class="mini">${escapeHtml(it.grams!=null ? (it.grams+" g") : "‚Äî")}</div></td>
        <td>
          <select data-idx="${idx}" class="valSel">${options}</select>
          <div class="mini" style="margin-top:6px"></div>
        </td>
        <td><input data-idx="${idx}" class="valNote" type="text" value="${escapeHtml(it.note||"")}" placeholder="ex: 1/2 pomme, cru/cuit‚Ä¶"></td>
      `;
      body.appendChild(tr);

      const mini = tr.querySelector("td:nth-child(3) .mini");
      const nm = foodName(it.chosenId) || "";
      mini.innerHTML = `${inferState(nm)?`<span class="pill">${escapeHtml(inferState(nm))}</span>`:""} <span class="pill accent">${escapeHtml(nm||it.label)}</span>`;
    });

    $("#validateSummary").innerHTML = `Recette : <strong>${escapeHtml(res.name)}</strong> ‚Ä¢ Ingr√©dients : <strong>${res.items.length}</strong> ‚Ä¢ √Ä v√©rifier : <strong>${toCheck}</strong>`;
    $("#ovValidate").style.display="flex";
  }

  safeOn("#btnDoImport","click", async ()=>{
    const res = await parseImportText($("#importText").value);
    if(!res){ alert("Colle une recette."); return; }
    // If any ingredient has multiple strong matches and query is generic, we still validate
    openValidate(res);
  });

  function closeValidate(){ $("#ovValidate").style.display="none"; }
  safeOn("#btnCloseValidate","click",closeValidate);
  safeOn("#ovValidate","click",(e)=>{ if(e.target && e.target.id==="ovValidate") closeValidate(); });

  // live update "pills" for select change
  document.addEventListener("change",(e)=>{
    const sel=e.target;
    if(sel && sel.classList && sel.classList.contains("valSel")){
      const idx=Number(sel.getAttribute("data-idx"));
      if(!pendingImport || !pendingImport.items || !pendingImport.items[idx]) return;
      pendingImport.items[idx].chosenId = sel.value;
      const mini = sel.parentElement.querySelector(".mini");
      if(mini){
        const nm=foodName(sel.value)||"";
        mini.innerHTML = `${inferState(nm)?`<span class="pill">${escapeHtml(inferState(nm))}</span>`:""} <span class="pill accent">${escapeHtml(nm||pendingImport.items[idx].label)}</span>`;
      }
    }
  });

  safeOn("#btnConfirmImport","click",()=>{
    if(!pendingImport) return;

    // read selections and notes
    const items=pendingImport.items;
    $all(".valSel").forEach(sel=>{
      const idx=Number(sel.getAttribute("data-idx"));
      items[idx].chosenId = sel.value || "";
    });
    $all(".valNote").forEach(inp=>{
      const idx=Number(inp.getAttribute("data-idx"));
      items[idx].note = (inp.value||"").trim();
    });

    const ingredients = items.filter(it=>it.chosenId).map(it=>({
      foodId: it.chosenId,
      grams: Number(it.grams||0),
      qtyText: it.qtyText || "",
      label: it.label || "",
      note: it.note || ""
    }));

    if(!ingredients.length){ alert("Aucun ingr√©dient valide."); return; }

    const obj = {
      id: uid(),
      name: pendingImport.name || "Recette import√©e",
      mainCat: "Healthy",
      subCat: "Plat",
      difficulty: "Facile",
      timeMin: 0,
      servings: 1,
      autoMacros: true,
      photo: importPhotoData || null,
      ingredients,
      steps: pendingImport.instructions || "",
      notes: (pendingImport.unknown && pendingImport.unknown.length) ? ("‚ö†Ô∏è √Ä v√©rifier : " + pendingImport.unknown.join(" | ")) : "",
      updatedAt: Date.now(),
      createdAt: Date.now(),
    };

    const t=calcTotals(obj.ingredients);
    obj.kcal=Math.round(t.kcal);
    obj.p=fmt1(t.p); obj.c=fmt1(t.c); obj.f=fmt1(t.f);

    state.recipes.unshift(obj);
    saveState();

    // close overlays
    closeValidate();
    closeImport();
    importPhotoData=null;
    $("#importPhoto").value="";
    $("#importImgBox").innerHTML="<span>Ajouter une photo</span>";

    renderRecipes();
    openRecipe(obj.id);
    showToast("Import ‚úÖ");
  });

  // ---------- shopping list ----------
  function buildShoppingText(recipe){
    const map=new Map(); // foodId -> grams
    (recipe.ingredients||[]).forEach(it=>{
      if(!it.foodId) return;
      const g=Number(it.grams||0);
      map.set(it.foodId, (map.get(it.foodId)||0) + g);
    });
    const lines=[];
    [...map.entries()].sort((a,b)=>foodName(a[0]).localeCompare(foodName(b[0]),"fr")).forEach(([id,g])=>{
      lines.push(`- ${foodName(id)} ‚Äî ${Math.round(g)} g`);
    });
    return `Liste de course ‚Äî ${recipe.name}\n\n` + lines.join("\n");
  }
  function openShop(){
    const r=state.recipes.find(x=>x.id===currentId);
    if(!r) return;
    $("#shopText").value = buildShoppingText(r);
    $("#ovShop").style.display="flex";
  }
  function closeShop(){ $("#ovShop").style.display="none"; }
  safeOn("#btnShop","click",openShop);
  safeOn("#btnCloseShop","click",closeShop);
  safeOn("#ovShop","click",(e)=>{ if(e.target && e.target.id==="ovShop") closeShop(); });
  safeOn("#btnCopyShop","click", async ()=>{
    try{
      await navigator.clipboard.writeText($("#shopText").value);
      showToast("Copi√© ‚úÖ");
    }catch{
      alert("Copie impossible ‚Äî s√©lectionne et copie manuellement.");
    }
  });

  // ---------- init ----------
  renderRecipes();
</script>
</body>
</html>
