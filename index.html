<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Chef Gemini Pro</title>
    <style>
        :root { --primary: #27ae60; --dark: #2c3e50; --light: #f4f7f6; }
        body { font-family: 'Segoe UI', sans-serif; background: var(--light); color: var(--dark); margin: 0; padding: 15px; }
        .container { max-width: 800px; margin: 0 auto; }
        .card { background: white; border-radius: 15px; padding: 20px; margin-bottom: 20px; box-shadow: 0 4px 12px rgba(0,0,0,0.08); }
        input, select, textarea { width: 100%; padding: 12px; margin: 10px 0; border: 1px solid #ddd; border-radius: 8px; font-size: 16px; box-sizing: border-box; }
        .btn { padding: 14px; border: none; border-radius: 8px; cursor: pointer; font-weight: bold; width: 100%; transition: 0.2s; font-size: 16px; margin-top: 5px; }
        .btn-add { background: var(--primary); color: white; }
        .btn-save { background: var(--dark); color: white; }
        
        .dashboard { display: flex; justify-content: space-around; background: var(--dark); color: white; padding: 15px; border-radius: 12px; text-align: center; margin-bottom: 20px; position: sticky; top: 10px; z-index: 10; }
        .macro-item span { display: block; font-size: 1.4em; font-weight: bold; color: var(--primary); }

        .search-container { position: relative; }
        #results { position: absolute; width: 100%; background: white; border: 1px solid #ddd; z-index: 5; max-height: 150px; overflow-y: auto; border-radius: 8px; display: none; }
        .result-item { padding: 10px; cursor: pointer; border-bottom: 1px solid #eee; }
        .result-item:hover { background: #f1f1f1; }

        .ing-list-item { display: flex; justify-content: space-between; padding: 10px; background: #fafafa; margin-bottom: 5px; border-radius: 5px; border-left: 3px solid var(--primary); }
        .recipe-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(280px, 1fr)); gap: 15px; }
        .recipe-box { background: white; border-radius: 12px; overflow: hidden; box-shadow: 0 2px 8px rgba(0,0,0,0.1); border-top: 5px solid var(--primary); }
        .recipe-info { padding: 15px; }
        
        /* LA CORRECTION EST ICI */
        .hidden { display: none !important; }
        .modal { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); display: flex; align-items: center; justify-content: center; z-index: 100; }
    </style>
</head>
<body>

<div class="container">
    <div class="dashboard">
        <div class="macro-item"><span id="liveCal">0</span><small>kcal/part</small></div>
        <div class="macro-item"><span id="liveProt">0</span><small>Prot</small></div>
        <div class="macro-item"><span id="liveGlu">0</span><small>Glu</small></div>
        <div class="macro-item"><span id="liveLip">0</span><small>Lip</small></div>
    </div>

    <div class="card">
        <h2 id="formTitle">ğŸ³ Nouvelle Recette</h2>
        <input type="text" id="rName" placeholder="Nom de la recette">
        <div style="display: flex; gap: 10px;">
            <select id="rTheme"><option value="Healthy">ğŸŒ¿ Healthy</option><option value="Gourmand">ğŸ« Gourmand</option></select>
            <select id="rSub"><option value="Entree">ğŸ¥— EntrÃ©e</option><option value="Plat">ğŸ› Plat</option><option value="Dessert">ğŸ° Dessert</option><option value="Gouter">ğŸª GoÃ»ter</option><option value="Bakery">ğŸ¥– Bakery</option></select>
        </div>
        <div style="display: flex; align-items: center; gap: 10px;">
            <label>Parts :</label><input type="number" id="rServ" value="1" min="1" style="width: 70px;" oninput="updateMacros()">
            <input type="file" id="rImg" accept="image/*" style="font-size: 11px;">
        </div>
        <hr>
        <div class="search-container">
            <input type="text" id="search" placeholder="Chercher un aliment..." oninput="doSearch()">
            <div id="results"></div>
        </div>
        <div id="selectedName" style="color: var(--primary); font-weight: bold; margin: 5px 0;"></div>
        <div style="display: flex; gap: 10px;">
            <input type="number" id="qty" placeholder="QuantitÃ©">
            <button class="btn btn-add" style="width: 80px;" onclick="addIng()">OK</button>
        </div>
        <div id="ingCurrentList" style="margin: 15px 0;"></div>
        <textarea id="rInst" rows="3" placeholder="Instructions..."></textarea>
        <button class="btn btn-save" onclick="saveRecipe()">ğŸ’¾ SAUVEGARDER</button>
        <button id="cancelEdit" class="btn hidden" style="background:#95a5a6; color:white;" onclick="resetAll()">Annuler</button>
    </div>

    <div class="card">
        <h3>â• Ajouter un aliment Ã  la base</h3>
        <input type="text" id="newName" placeholder="Nom (ex: Skyr Vanille)">
        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px;">
            <input type="number" id="newCal" placeholder="Cal / 100g">
            <input type="number" id="newProt" placeholder="Prot / 100g">
            <input type="number" id="newGlu" placeholder="Glu / 100g">
            <input type="number" id="newLip" placeholder="Lip / 100g">
        </div>
        <button class="btn" style="background:#e67e22; color:white;" onclick="addNewAliment()">Ajouter cet aliment</button>
    </div>

    <button class="btn" style="background:#7f8c8d; color:white; margin-bottom: 20px;" onclick="exportJSON()">ğŸ“¤ Exporter Backup</button>
    <h2>ğŸ“– Mon Carnet</h2>
    <div id="carnet" class="recipe-grid"></div>
</div>

<div id="modalCourse" class="modal hidden">
    <div class="card" style="width: 80%; max-width: 400px; position:relative;">
        <h3>ğŸ›’ Liste de courses</h3>
        <div id="listContent" style="margin-bottom: 20px;"></div>
        <button class="btn btn-save" onclick="closeModal()">Fermer</button>
    </div>
</div>

<script>
    let db = JSON.parse(localStorage.getItem('myFoodDB')) || [
        { name: "Poulet (filet cru)", cal: 110, prot: 23, glu: 0, lip: 1.2, base: 100 },
        { name: "Poulet (filet cuit)", cal: 165, prot: 31, glu: 0, lip: 3.6, base: 100 },
        { name: "Riz Basmati (cru)", cal: 350, prot: 7, glu: 78, lip: 0.5, base: 100 },
        { name: "Riz Basmati (cuit)", cal: 130, prot: 2.7, glu: 28, lip: 0.3, base: 100 },
        { name: "PÃ¢tes (crues)", cal: 350, prot: 12, glu: 72, lip: 1.5, base: 100 },
        { name: "Oeuf (unitÃ©)", cal: 70, prot: 6, glu: 0.5, lip: 5, base: 1 },
        { name: "Skyr", cal: 57, prot: 11, glu: 4, lip: 0, base: 100 },
        { name: "Avocat (unitÃ©)", cal: 250, prot: 3, glu: 12, lip: 23, base: 1 },
        { name: "Beurre", cal: 717, prot: 0.8, glu: 0.1, lip: 81, base: 100 }
    ];
    let currentIngs = []; let selectedFood = null; let editId = null;

    function doSearch() {
        const q = document.getElementById('search').value.toLowerCase();
        const res = document.getElementById('results');
        res.innerHTML = ""; if(!q) { res.style.display="none"; return; }
        db.filter(f => f.name.toLowerCase().includes(q)).forEach(f => {
            let d = document.createElement('div'); d.className = "result-item"; d.innerText = f.name;
            d.onclick = () => { selectedFood = f; document.getElementById('selectedName').innerText = f.name; res.style.display="none"; };
            res.appendChild(d);
        });
        res.style.display="block";
    }
    function addIng() {
        let qty = parseFloat(document.getElementById('qty').value);
        if(!selectedFood || !qty) return;
        let f = qty / selectedFood.base;
        currentIngs.push({ name: selectedFood.name, qty: qty, c: selectedFood.cal * f, p: selectedFood.prot * f, g: selectedFood.glu * f, l: selectedFood.lip * f });
        renderIngs(); updateMacros(); selectedFood = null; document.getElementById('selectedName').innerText = ""; document.getElementById('search').value = "";
    }
    function renderIngs() {
        document.getElementById('ingCurrentList').innerHTML = currentIngs.map((i, idx) => `
            <div class="ing-list-item"><span>${i.name} (${i.qty})</span><span onclick="currentIngs.splice(${idx},1); renderIngs(); updateMacros();" style="color:red; cursor:pointer;">âœ–</span></div>
        `).join('');
    }
    function updateMacros() {
        let s = parseFloat(document.getElementById('rServ').value) || 1;
        let sums = currentIngs.reduce((a,b) => ({c:a.c+b.c, p:a.p+b.p, g:a.g+b.g, l:a.l+b.l}), {c:0,p:0,g:0,l:0});
        document.getElementById('liveCal').innerText = Math.round(sums.c / s);
        document.getElementById('liveProt').innerText = Math.round(sums.p / s);
        document.getElementById('liveGlu').innerText = Math.round(sums.g / s);
        document.getElementById('liveLip').innerText = Math.round(sums.l / s);
    }
    async function saveRecipe() {
        let name = document.getElementById('rName').value; if(!name || currentIngs.length == 0) return alert("Nom et ingrÃ©dients requis !");
        let imgFile = document.getElementById('rImg').files[0];
        let imgBase64 = editId ? (getRecs().find(x=>x.id==editId).img || "") : "";
        if(imgFile) imgBase64 = await to64(imgFile);
        let recipe = { id: editId || Date.now(), name, theme: document.getElementById('rTheme').value, sub: document.getElementById('rSub').value, serv: document.getElementById('rServ').value, ings: currentIngs, inst: document.getElementById('rInst').value, img: imgBase64, res: { c: document.getElementById('liveCal').innerText, p: document.getElementById('liveProt').innerText, g: document.getElementById('liveGlu').innerText, l: document.getElementById('liveLip').innerText } };
        let recs = getRecs(); if(editId) recs = recs.map(r => r.id == editId ? recipe : r); else recs.push(recipe);
        localStorage.setItem('myRecipes', JSON.stringify(recs)); resetAll(); renderCarnet();
    }
    function addNewAliment() {
        let n = document.getElementById('newName').value; let c = parseFloat(document.getElementById('newCal').value); if(!n || isNaN(c)) return alert("Nom et calories requis");
        db.push({ name: n, cal: c, prot: parseFloat(document.getElementById('newProt').value)||0, glu: parseFloat(document.getElementById('newGlu').value)||0, lip: parseFloat(document.getElementById('newLip').value)||0, base: 100 });
        localStorage.setItem('myFoodDB', JSON.stringify(db)); alert("Aliment ajoutÃ© !");
        document.querySelectorAll('#newName, #newCal, #newProt, #newGlu, #newLip').forEach(i => i.value="");
    }
    function renderCarnet() {
        document.getElementById('carnet').innerHTML = getRecs().map(r => `
            <div class="recipe-box">
                ${r.img ? `<img src="${r.img}" style="width:100%;height:150px;object-fit:cover;">` : '<div style="height:150px;background:#eee;display:flex;align-items:center;justify-content:center">Pas de photo</div>'}
                <div class="recipe-info">
                    <strong>${r.name}</strong><br><small>${r.theme} - ${r.sub}</small><br>
                    <span>${r.res.c} kcal / part</span><br>
                    <button class="btn" style="background:#3498db;color:white;font-size:12px;" onclick="showCourses(${r.id})">ğŸ›’ Courses</button>
                    <button class="btn" style="background:#95a5a6;color:white;font-size:12px;" onclick="loadEdit(${r.id})">Modifier</button>
                    <button class="btn" style="background:#e74c3c;color:white;font-size:12px;" onclick="delRec(${r.id})">Suppr</button>
                </div>
            </div>
        `).join('');
    }
    function showCourses(id) { let r = getRecs().find(x=>x.id==id); document.getElementById('listContent').innerHTML = r.ings.map(i => `<div>â˜ ${i.name} (${i.qty})</div>`).join(''); document.getElementById('modalCourse').classList.remove('hidden'); }
    function closeModal() { document.getElementById('modalCourse').classList.add('hidden'); }
    function getRecs() { return JSON.parse(localStorage.getItem('myRecipes')) || []; }
    function resetAll() { editId = null; currentIngs = []; document.getElementById('rImg').value = ""; document.querySelectorAll('#rName, #rInst, #qty, #search').forEach(i => i.value=""); document.getElementById('formTitle').innerText = "ğŸ³ Nouvelle Recette"; document.getElementById('cancelEdit').classList.add('hidden'); renderIngs(); updateMacros(); }
    function delRec(id) { if(confirm("Supprimer ?")) { localStorage.setItem('myRecipes', JSON.stringify(getRecs().filter(x=>x.id!=id))); renderCarnet(); } }
    function loadEdit(id) { let r = getRecs().find(x=>x.id==id); editId = id; document.getElementById('rName').value = r.name; document.getElementById('rTheme').value = r.theme; document.getElementById('rSub').value = r.sub; document.getElementById('rServ').value = r.serv; document.getElementById('rInst').value = r.inst; currentIngs = [...r.ings]; document.getElementById('formTitle').innerText = "ğŸ“ Modifier la recette"; document.getElementById('cancelEdit').classList.remove('hidden'); renderIngs(); updateMacros(); window.scrollTo(0,0); }
    function to64(file) { return new Promise((res) => { let r = new FileReader(); r.onload = () => res(r.result); r.readAsDataURL(file); }); }
    function exportJSON() { let data = { recipes: getRecs(), db: db }; let blob = new Blob([JSON.stringify(data)], {type: "text/plain"}); let a = document.createElement("a"); a.href = URL.createObjectURL(blob); a.download = "backup.txt"; a.click(); }
    renderCarnet();
</script>
</body>
</html>