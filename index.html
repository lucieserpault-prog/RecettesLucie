<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Chef Gemini Pro - Healthy & Gourmand</title>
    <style>
        :root {
            --primary: #27ae60;
            --secondary: #e67e22;
            --dark: #2c3e50;
            --light: #f4f7f6;
            --white: #ffffff;
        }

        body { font-family: 'Segoe UI', sans-serif; background: var(--light); color: var(--dark); margin: 0; padding: 15px; }
        .container { max-width: 800px; margin: 0 auto; }
        
        /* Design des Cartes */
        .card { background: var(--white); border-radius: 15px; padding: 20px; margin-bottom: 20px; box-shadow: 0 4px 12px rgba(0,0,0,0.08); }
        h2 { border-left: 5px solid var(--primary); padding-left: 10px; margin-top: 0; }

        /* Formulaires */
        input, select, textarea { width: 100%; padding: 12px; margin: 10px 0; border: 1px solid #ddd; border-radius: 8px; font-size: 16px; box-sizing: border-box; }
        .btn { padding: 14px; border: none; border-radius: 8px; cursor: pointer; font-weight: bold; width: 100%; transition: 0.2s; font-size: 16px; }
        .btn-add { background: var(--primary); color: white; }
        .btn-save { background: var(--dark); color: white; margin-top: 10px; }
        .btn-course { background: #3498db; color: white; }

        /* Dashboard Macros */
        .dashboard { display: flex; justify-content: space-around; background: var(--dark); color: white; padding: 15px; border-radius: 12px; text-align: center; position: sticky; top: 10px; z-index: 10; margin-bottom: 20px; }
        .macro-item span { display: block; font-size: 1.4em; font-weight: bold; color: var(--primary); }

        /* Recherche */
        .search-container { position: relative; }
        #results { position: absolute; width: 100%; background: white; border: 1px solid #ddd; z-index: 5; max-height: 150px; overflow-y: auto; border-radius: 8px; box-shadow: 0 4px 8px rgba(0,0,0,0.1); }
        .result-item { padding: 10px; cursor: pointer; border-bottom: 1px solid #eee; }
        .result-item:hover { background: #f1f1f1; }

        /* Liste Ingr√©dients */
        .ing-list-item { display: flex; justify-content: space-between; padding: 10px; background: #fafafa; margin-bottom: 5px; border-radius: 5px; }
        .del-btn { color: #e74c3c; cursor: pointer; font-weight: bold; }

        /* Carnet de Recettes */
        .recipe-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(280px, 1fr)); gap: 15px; }
        .recipe-box { background: white; border-radius: 12px; overflow: hidden; box-shadow: 0 2px 8px rgba(0,0,0,0.1); }
        .recipe-box img { width: 100%; height: 160px; object-fit: cover; }
        .recipe-info { padding: 15px; }
        .tag { display: inline-block; padding: 3px 8px; border-radius: 4px; font-size: 12px; background: #eee; margin-right: 5px; margin-bottom: 10px; }
        
        .hidden { display: none; }
        .modal { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); display: flex; align-items: center; justify-content: center; z-index: 100; }
    </style>
</head>
<body>

<div class="container">
    <div class="dashboard">
        <div class="macro-item"><span id="liveCal">0</span><small>kcal/part</small></div>
        <div class="macro-item"><span id="liveProt">0</span><small>Prot</small></div>
        <div class="macro-item"><span id="liveGlu">0</span><small>Glu</small></div>
        <div class="macro-item"><span id="liveLip">0</span><small>Lip</small></div>
    </div>

    <div class="card">
        <h2 id="formTitle">üç≥ Cr√©er une recette</h2>
        <input type="text" id="rName" placeholder="Nom de la recette">
        
        <div style="display: flex; gap: 10px;">
            <select id="rTheme">
                <option value="Healthy">üåø Healthy</option>
                <option value="Gourmand">üç´ Gourmand</option>
            </select>
            <select id="rSub">
                <option value="Entree">ü•ó Entr√©e</option>
                <option value="Plat">üçõ Plat</option>
                <option value="Dessert">üç∞ Dessert</option>
                <option value="Gouter">üç™ Go√ªter</option>
                <option value="Bakery">ü•ñ Bakery</option>
            </select>
        </div>

        <div style="display: flex; align-items: center; gap: 10px;">
            <label>Parts :</label>
            <input type="number" id="rServ" value="1" min="1" style="width: 80px;" oninput="updateMacros()">
            <input type="file" id="rImg" accept="image/*" style="font-size: 12px;">
        </div>

        <hr>

        <div class="search-container">
            <input type="text" id="search" placeholder="Chercher un aliment (Cru/Cuit)..." oninput="doSearch()">
            <div id="results"></div>
        </div>
        <div id="selectedName" style="color: var(--primary); font-weight: bold; margin-bottom: 5px;"></div>
        
        <div style="display: flex; gap: 10px;">
            <input type="number" id="qty" placeholder="Quantit√© (g ou unit√©)">
            <button class="btn btn-add" style="width: 100px;" onclick="addIng()">OK</button>
        </div>

        <div id="ingCurrentList" style="margin-top: 15px;"></div>

        <textarea id="rInst" rows="3" placeholder="Instructions (√©tapes de pr√©paration...)"></textarea>
        
        <button class="btn btn-save" onclick="saveRecipe()">üíæ SAUVEGARDER LA RECETTE</button>
        <button id="cancelEdit" class="btn hidden" style="background: #95a5a6; color: white;" onclick="resetAll()">Annuler modification</button>
    </div>

    <div class="card">
        <h3>‚ûï Ajouter un nouvel aliment √† la base</h3>
        <input type="text" id="newName" placeholder="Nom de l'aliment (ex: Yaourt Brebis)">
        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px;">
            <input type="number" id="newCal" placeholder="Cal / 100g">
            <input type="number" id="newProt" placeholder="Prot / 100g">
            <input type="number" id="newGlu" placeholder="Glu / 100g">
            <input type="number" id="newLip" placeholder="Lip / 100g">
        </div>
        <button class="btn" style="background: var(--secondary); color: white;" onclick="addNewAliment()">Enregistrer cet aliment</button>
    </div>

    <button class="btn" style="background: #7f8c8d; color: white; margin-bottom: 20px;" onclick="exportJSON()">üì§ Exporter Backup (Fichier texte)</button>

    <h2>üìñ Mon Carnet de Recettes</h2>
    <div id="carnet" class="recipe-grid"></div>
</div>

<div id="modalCourse" class="modal hidden">
    <div class="card" style="width: 80%; max-width: 400px;">
        <h3>üõí Liste de courses</h3>
        <div id="listContent"></div>
        <button class="btn btn-save" onclick="closeModal()">Fermer</button>
    </div>
</div>

<script>
    // --- DONN√âES ---
    let db = JSON.parse(localStorage.getItem('myFoodDB')) || [
        { name: "Poulet (filet cru)", cal: 110, prot: 23, glu: 0, lip: 1.2, base: 100 },
        { name: "Poulet (filet cuit)", cal: 165, prot: 31, glu: 0, lip: 3.6, base: 100 },
        { name: "Riz Basmati (cru)", cal: 350, prot: 7, glu: 78, lip: 0.5, base: 100 },
        { name: "Riz Basmati (cuit)", cal: 130, prot: 2.7, glu: 28, lip: 0.3, base: 100 },
        { name: "P√¢tes (crues)", cal: 350, prot: 12, glu: 72, lip: 1.5, base: 100 },
        { name: "Oeuf (unit√©)", cal: 70, prot: 6, glu: 0.5, lip: 5, base: 1 },
        { name: "Skyr", cal: 57, prot: 11, glu: 4, lip: 0, base: 100 },
        { name: "Avocat (unit√©)", cal: 250, prot: 3, glu: 12, lip: 23, base: 1 },
        { name: "Beurre", cal: 717, prot: 0.8, glu: 0.1, lip: 81, base: 100 }
    ];

    let currentIngs = [];
    let selectedFood = null;
    let editId = null;

    // --- LOGIQUE RECHERCHE ---
    function doSearch() {
        const q = document.getElementById('search').value.toLowerCase();
        const res = document.getElementById('results');
        res.innerHTML = "";
        if(!q) return;
        db.filter(f => f.name.toLowerCase().includes(q)).forEach(f => {
            let d = document.createElement('div');
            d.className = "result-item";
            d.innerText = f.name;
            d.onclick = () => { selectedFood = f; document.getElementById('selectedName').innerText = f.name; res.innerHTML = ""; };
            res.appendChild(d);
        });
    }

    // --- GESTION INGR√âDIENTS ---
    function addIng() {
        let qty = parseFloat(document.getElementById('qty').value);
        if(!selectedFood || !qty) return;
        let factor = qty / selectedFood.base;
        currentIngs.push({
            name: selectedFood.name,
            qty: qty,
            c: selectedFood.cal * factor,
            p: selectedFood.prot * factor,
            g: selectedFood.glu * factor,
            l: selectedFood.lip * factor
        });
        renderIngs();
        updateMacros();
        selectedFood = null; document.getElementById('selectedName').innerText = ""; document.getElementById('search').value = "";
    }

    function renderIngs() {
        document.getElementById('ingCurrentList').innerHTML = currentIngs.map((i, idx) => `
            <div class="ing-list-item">
                <span>${i.name} (${i.qty})</span>
                <span class="del-btn" onclick="currentIngs.splice(${idx},1); renderIngs(); updateMacros();">‚úñ</span>
            </div>
        `).join('');
    }

    function updateMacros() {
        let s = parseFloat(document.getElementById('rServ').value) || 1;
        let sums = currentIngs.reduce((a,b) => ({c:a.c+b.c, p:a.p+b.p, g:a.g+b.g, l:a.l+b.l}), {c:0,p:0,g:0,l:0});
        document.getElementById('liveCal').innerText = Math.round(sums.c / s);
        document.getElementById('liveProt').innerText = Math.round(sums.p / s);
        document.getElementById('liveGlu').innerText = Math.round(sums.g / s);
        document.getElementById('liveLip').innerText = Math.round(sums.l / s);
    }

    // --- SAUVEGARDE RECETTE ---
    async function saveRecipe() {
        let name = document.getElementById('rName').value;
        if(!name || currentIngs.length == 0) return alert("Remplis au moins le nom et un ingr√©dient !");
        
        let imgFile = document.getElementById('rImg').files[0];
        let imgBase64 = editId ? (getRecs().find(x=>x.id==editId).img || "") : "";
        if(imgFile) imgBase64 = await to64(imgFile);

        let recipe = {
            id: editId || Date.now(),
            name,
            theme: document.getElementById('rTheme').value,
            sub: document.getElementById('rSub').value,
            serv: document.getElementById('rServ').value,
            ings: currentIngs,
            inst: document.getElementById('rInst').value,
            img: imgBase64,
            res: {
                c: document.getElementById('liveCal').innerText,
                p: document.getElementById('liveProt').innerText,
                g: document.getElementById('liveGlu').innerText,
                l: document.getElementById('liveLip').innerText
            }
        };

        let recs = getRecs();
        if(editId) recs = recs.map(r => r.id == editId ? recipe : r);
        else recs.push(recipe);
        
        localStorage.setItem('myRecipes', JSON.stringify(recs));
        resetAll();
        renderCarnet();
    }

    // --- ALIMENT PERSO ---
    function addNewAliment() {
        let n = document.getElementById('newName').value;
        let c = parseFloat(document.getElementById('newCal').value);
        if(!n || isNaN(c)) return alert("Nom et calories obligatoires");
        db.push({
            name: n, cal: c, 
            prot: parseFloat(document.getElementById('newProt').value)||0,
            glu: parseFloat(document.getElementById('newGlu').value)||0,
            lip: parseFloat(document.getElementById('newLip').value)||0,
            base: 100
        });
        localStorage.setItem('myFoodDB', JSON.stringify(db));
        alert("Aliment ajout√© !");
        document.querySelectorAll('#newName, #newCal, #newProt, #newGlu, #newLip').forEach(i => i.value="");
    }

    // --- CARNET & COURSES ---
    function renderCarnet() {
        let html = getRecs().map(r => `
            <div class="recipe-box">
                ${r.img ? `<img src="${r.img}">` : '<div style="height:160px; background:#ddd; display:flex; align-items:center; justify-content:center">Pas de photo</div>'}
                <div class="recipe-info">
                    <span class="tag">${r.theme}</span><span class="tag">${r.sub}</span>
                    <h3 style="margin:5px 0">${r.name}</h3>
                    <p style="font-size:14px; color:#666"><strong>${r.res.c} kcal</strong> / part</p>
                    <button class="btn btn-course" onclick="showCourses(${r.id})">üõí Courses</button>
                    <div style="display:flex; gap:5px; margin-top:5px;">
                        <button class="btn btn-save" style="font-size:12px;" onclick="loadEdit(${r.id})">Modifier</button>
                        <button class="btn" style="font-size:12px; background:#e74c3c; color:white;" onclick="delRec(${r.id})">Suppr</button>
                    </div>
                </div>
            </div>
        `).join('');
        document.getElementById('carnet').innerHTML = html;
    }

    function showCourses(id) {
        let r = getRecs().find(x=>x.id==id);
        document.getElementById('listContent').innerHTML = r.ings.map(i => `<div>‚òê ${i.name} (${i.qty}g/u)</div>`).join('');
        document.getElementById('modalCourse').classList.remove('hidden');
    }

    function loadEdit(id) {
        let r = getRecs().find(x=>x.id==id);
        editId = id;
        document.getElementById('rName').value = r.name;
        document.getElementById('rTheme').value = r.theme;
        document.getElementById('rSub').value = r.sub;
        document.getElementById('rServ').value = r.serv;
        document.getElementById('rInst').value = r.inst;
        currentIngs = [...r.ings];
        document.getElementById('formTitle').innerText = "üìù Modifier la recette";
        document.getElementById('cancelEdit').classList.remove('hidden');
        renderIngs(); updateMacros(); window.scrollTo(0,0);
    }

    // --- UTILS ---
    function getRecs() { return JSON.parse(localStorage.getItem('myRecipes')) || []; }
    function resetAll() {
        editId = null; currentIngs = []; document.getElementById('rImg').value = "";
        document.querySelectorAll('#rName, #rInst, #qty, #search').forEach(i => i.value="");
        document.getElementById('formTitle').innerText = "üç≥ Cr√©er une recette";
        document.getElementById('cancelEdit').classList.add('hidden');
        renderIngs(); updateMacros();
    }
    function delRec(id) { if(confirm("Supprimer ?")) { localStorage.setItem('myRecipes', JSON.stringify(getRecs().filter(x=>x.id!=id))); renderCarnet(); } }
    function closeModal() { document.getElementById('modalCourse').classList.add('hidden'); }
    function to64(file) { return new Promise((res) => { let r = new FileReader(); r.onload = () => res(r.result); r.readAsDataURL(file); }); }
    function exportJSON() {
        let data = { recipes: getRecs(), db: db };
        let blob = new Blob([JSON.stringify(data)], {type: "text/plain"});
        let a = document.createElement("a"); a.href = URL.createObjectURL(blob); a.download = "backup_cuisine.txt"; a.click();
    }

    renderCarnet();
</script>

</body>
</html>