<!doctype html>
<html lang="fr">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Ton carnet</title>
<style>
:root{--bg:#070a14;--bg2:#0b1020;--text:#eef1ff;--muted:#aab3de;--line:rgba(255,255,255,.10);--accent:#7c5cff;--ok:#22c55e;--warn:#f59e0b;--danger:#ef4444;--shadow:0 18px 60px rgba(0,0,0,.55);--r:22px;--r2:16px;--max:1200px;--sans:ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial}
*{box-sizing:border-box} body{margin:0;font-family:var(--sans);color:var(--text);
background:radial-gradient(1200px 680px at 12% 0%, rgba(124,92,255,.20), transparent 58%),
radial-gradient(900px 560px at 90% 12%, rgba(34,197,94,.16), transparent 60%),
radial-gradient(900px 560px at 25% 100%, rgba(245,158,11,.10), transparent 62%),
linear-gradient(180deg,var(--bg),var(--bg2));}
.wrap{max-width:var(--max);margin:0 auto;padding:20px 16px 70px;}
header{display:flex;align-items:center;justify-content:space-between;gap:12px;padding:10px 0 14px;}
.brand{display:flex;align-items:center;gap:12px} .logo{width:44px;height:44px;border-radius:16px;background:linear-gradient(135deg, rgba(124,92,255,.55), rgba(34,197,94,.35));border:1px solid rgba(255,255,255,.12);box-shadow:0 14px 40px rgba(0,0,0,.45);}
h1{margin:0;font-size:22px;letter-spacing:.2px} .sub{margin-top:4px;color:var(--muted);font-size:13px;line-height:1.35}
.topActions{display:flex;gap:10px;flex-wrap:wrap;justify-content:flex-end}
.btn{border:1px solid var(--line);background:linear-gradient(180deg, rgba(255,255,255,.09), rgba(255,255,255,.03));color:var(--text);padding:10px 12px;border-radius:14px;cursor:pointer;display:inline-flex;gap:8px;align-items:center;box-shadow:0 10px 26px rgba(0,0,0,.24);font-weight:850;font-size:13px;user-select:none;}
.btn.primary{border-color:rgba(124,92,255,.35);background:linear-gradient(180deg, rgba(124,92,255,.30), rgba(124,92,255,.12));}
.btn.danger{border-color:rgba(239,68,68,.35);background:linear-gradient(180deg, rgba(239,68,68,.22), rgba(239,68,68,.08));}
.btn.ghost{background:transparent;box-shadow:none}
.tabs{display:flex;gap:8px;flex-wrap:wrap;margin:8px 0 14px;} .tab{padding:9px 12px;border-radius:999px;border:1px solid var(--line);background:rgba(0,0,0,.12);color:var(--muted);font-weight:850;font-size:13px;cursor:pointer;user-select:none;}
.tab.active{color:var(--text);border-color:rgba(124,92,255,.38);background:rgba(124,92,255,.14);}
.bigCard{border-radius:var(--r);border:1px solid var(--line);background:linear-gradient(180deg, rgba(255,255,255,.07), rgba(255,255,255,.02));box-shadow:var(--shadow);padding:16px;position:relative;overflow:hidden;}
.bigCard:before{content:"";position:absolute;inset:-1px;background:radial-gradient(500px 260px at 20% 10%, rgba(124,92,255,.18), transparent 60%),radial-gradient(500px 260px at 90% 40%, rgba(34,197,94,.12), transparent 60%);pointer-events:none;}
.bigCard>*{position:relative} .hero{display:grid;grid-template-columns:1.2fr .8fr;gap:12px;margin-top:10px;} @media(max-width:980px){.hero{grid-template-columns:1fr;}}
.headline{font-size:28px;margin:0;letter-spacing:.2px} .small{color:var(--muted);margin-top:8px;line-height:1.45;font-size:13px}
.statsRow{display:flex;gap:10px;flex-wrap:wrap;margin-top:12px} .chip{display:inline-flex;align-items:center;gap:8px;padding:8px 12px;border-radius:999px;border:1px solid var(--line);background:rgba(0,0,0,.12);color:var(--muted);font-size:13px;font-weight:850;cursor:pointer;}
.panel{background:linear-gradient(180deg, rgba(255,255,255,.06), rgba(255,255,255,.02));border:1px solid var(--line);border-radius:var(--r);padding:14px;box-shadow:var(--shadow);}
.controls{display:grid;grid-template-columns:1.3fr .8fr .8fr .8fr .8fr .7fr;gap:10px;align-items:end;margin-top:14px;} @media(max-width:980px){.controls{grid-template-columns:1fr 1fr;}} @media(max-width:540px){.controls{grid-template-columns:1fr;}}
label{font-size:12px;color:var(--muted);display:block;margin:0 0 6px} input,select,textarea{width:100%;padding:11px 12px;border-radius:14px;border:1px solid var(--line);background:rgba(10,16,35,.55);color:var(--text);outline:none;}
.masonry{margin-top:14px;column-count:3;column-gap:12px;} @media(max-width:980px){.masonry{column-count:2;}} @media(max-width:620px){.masonry{column-count:1;}}
.card{break-inside:avoid;margin:0 0 12px;border-radius:var(--r2);overflow:hidden;border:1px solid var(--line);background:linear-gradient(180deg, rgba(255,255,255,.06), rgba(255,255,255,.02));box-shadow:0 12px 32px rgba(0,0,0,.32);cursor:pointer;}
.thumb{height:170px;background:linear-gradient(135deg, rgba(124,92,255,.25), rgba(34,197,94,.14));display:flex;align-items:center;justify-content:center;color:rgba(255,255,255,.80);font-weight:950;}
.thumb img{width:100%;height:100%;object-fit:cover;display:block} .cardBody{padding:12px 12px 14px} .name{margin:0;font-size:16px;font-weight:950}
.metaLine{margin-top:8px;color:var(--muted);font-size:12px;line-height:1.35} .smallRow{display:flex;gap:8px;flex-wrap:wrap;margin-top:10px}
.pill{font-size:11px;padding:5px 9px;border-radius:999px;border:1px solid var(--line);color:var(--muted);background:rgba(0,0,0,.12);font-weight:850;}
.pill.accent{border-color:rgba(124,92,255,.35);color:#dcd6ff;background:rgba(124,92,255,.12)} .pill.ok{border-color:rgba(34,197,94,.35);color:#c9f4da;background:rgba(34,197,94,.10)} .pill.warn{border-color:rgba(245,158,11,.35);color:#ffe7c2;background:rgba(245,158,11,.10)}
.overlay{position:fixed;inset:0;background:rgba(0,0,0,.58);display:none;align-items:center;justify-content:center;padding:18px;z-index:50;}
.modal{width:min(1040px,100%);max-height:88vh;overflow:auto;border-radius:24px;border:1px solid var(--line);background:linear-gradient(180deg, rgba(17,26,51,.98), rgba(10,16,35,.98));box-shadow:0 26px 90px rgba(0,0,0,.60);}
.modalHeader{display:flex;justify-content:space-between;align-items:center;gap:10px;padding:14px 14px 10px;border-bottom:1px solid var(--line);position:sticky;top:0;background:linear-gradient(180deg, rgba(17,26,51,.98), rgba(15,23,48,.98));backdrop-filter: blur(12px);z-index:2;}
.modalTitle{font-weight:950;font-size:14px;color:#dfe4ff} .modalBody{padding:14px} .divider{height:1px;background:var(--line);margin:12px 0}
.twoCol{display:grid;grid-template-columns:1fr 1fr;gap:12px;} @media(max-width:900px){.twoCol{grid-template-columns:1fr;}}
.imgBig{width:100%;height:260px;border-radius:18px;border:1px solid var(--line);overflow:hidden;background:rgba(0,0,0,.14);display:flex;align-items:center;justify-content:center;color:rgba(255,255,255,.78);font-weight:950;}
.imgBig img{width:100%;height:100%;object-fit:cover;display:block}
table{width:100%;border-collapse:collapse;overflow:hidden;border-radius:16px;border:1px solid var(--line);} th,td{padding:10px;font-size:13px;border-bottom:1px solid var(--line);vertical-align:top} th{color:var(--muted);font-weight:950;text-align:left;background:rgba(255,255,255,.04)} tr:last-child td{border-bottom:none}
.right{display:flex;gap:10px;justify-content:flex-end;flex-wrap:wrap} .mini{font-size:12px;color:var(--muted);margin-top:6px;line-height:1.35}
.toast{position:fixed;left:50%;bottom:18px;transform:translateX(-50%);background:rgba(17,26,51,.96);border:1px solid var(--line);color:var(--text);padding:10px 12px;border-radius:999px;box-shadow:0 18px 70px rgba(0,0,0,.55);display:none;z-index:80;font-size:13px;font-weight:850;}
.kbd{border:1px solid var(--line);background:rgba(0,0,0,.15);border-radius:8px;padding:1px 6px;font-weight:900;}
</style>
</head>
<body>
<div class="wrap">
  <header>
    <div class="brand"><div class="logo"></div><div>
      <h1>Ton carnet</h1>
      <div class="sub">2 cat√©gories ‚Ä¢ 4 sous-cat√©gories ‚Ä¢ Mode √©dition (PIN) ‚Ä¢ Import intelligent ‚Ä¢ 226 aliments.</div>
    </div></div>
    <div class="topActions">
      <button class="btn ghost" id="btnToggleEdit">üîí Mode √©dition</button>
      <button class="btn primary adminOnly" id="btnNew" style="display:none">Ôºã Nouvelle</button>
      <button class="btn adminOnly" id="btnOpenImport" style="display:none">üßæ Import Word</button>
      <button class="btn adminOnly" id="btnFoods" style="display:none">ü•ó Aliments</button>
    </div>
  </header>

  <div class="tabs">
    <div class="tab active" data-view="home">Accueil</div>
    <div class="tab" data-view="recipes">Recettes</div>
  </div>

  <div id="viewHome">
    <div class="hero">
      <div class="bigCard">
        <h2 class="headline">Ton carnet</h2>
        <div class="small">Clique une cat√©gorie pour voir les recettes. Pour ajouter / modifier / supprimer, active le <span class="kbd">Mode √©dition</span> (PIN).</div>
        <div class="statsRow" id="statsHome"></div>
      </div>
      <div class="bigCard">
        <div class="mini"><strong>Cat√©gories</strong></div>
        <div class="mini">Healthy / Gourmand</div>
        <div class="statsRow" id="homeMainCats"></div>
        <div class="divider"></div>
        <div class="mini">Entr√©e / Plat / Dessert / Bakery</div>
        <div class="statsRow" id="homeSubCats"></div>
      </div>
    </div>
  </div>

  <div id="viewRecipes" style="display:none">
    <div class="panel">
      <div class="controls">
        <div><label>Recherche intelligente</label><input id="q" type="text" placeholder="ex: poulet curry, banana bread‚Ä¶"></div>
        <div><label>Cat√©gorie</label><select id="mainCat"><option value="">Toutes</option></select></div>
        <div><label>Sous-cat√©gorie</label><select id="subCat"><option value="">Toutes</option></select></div>
        <div><label>Difficult√©</label><select id="diff"><option value="">Toutes</option><option>Facile</option><option>Moyen</option><option>Difficile</option></select></div>
        <div><label>Trier</label><select id="sort"><option value="recent">R√©cent</option><option value="name">Nom</option><option value="kcal">Calories</option><option value="protein">Prot√©ines</option><option value="time">Temps</option></select></div>
        <div class="right"><button class="btn" id="btnReset">‚Ü∫ Reset</button></div>
      </div>
    </div>
    <div class="statsRow" id="statsRecipes" style="margin-top:12px"></div>
    <div id="grid" class="masonry"></div>
  </div>
</div>

<!-- VIEW -->
<div class="overlay" id="overlayView"><div class="modal">
  <div class="modalHeader">
    <div class="modalTitle" id="viewTitle">Recette</div>
    <div class="right">
      <button class="btn adminOnly" id="btnEdit" style="display:none">‚úèÔ∏è</button>
      <button class="btn danger adminOnly" id="btnDelete" style="display:none">üóë</button>
      <button class="btn" id="btnCloseView">‚úï</button>
    </div>
  </div>
  <div class="modalBody" id="viewBody"></div>
</div></div>

<!-- PIN -->
<div class="overlay" id="overlayPin"><div class="modal" style="max-width:520px">
  <div class="modalHeader"><div class="modalTitle">Mode √©dition</div><div class="right"><button class="btn" id="btnClosePin">‚úï</button></div></div>
  <div class="modalBody">
    <div class="mini">PIN par d√©faut : <span class="kbd">1234</span></div>
    <div style="margin-top:10px">
      <input id="pinInput" type="number" inputmode="numeric" placeholder="Code PIN">
      <div class="right" style="margin-top:10px">
        <button class="btn danger" id="btnPinOff">D√©sactiver</button>
        <button class="btn primary" id="btnPinOk">Activer</button>
      </div>
    </div>
  </div>
</div></div>

<!-- FORM -->
<div class="overlay" id="overlayForm"><div class="modal">
  <div class="modalHeader">
    <div class="modalTitle" id="formTitle">Nouvelle recette</div>
    <div class="right"><button class="btn primary" id="btnSave">üíæ</button><button class="btn" id="btnCloseForm">‚úï</button></div>
  </div>
  <div class="modalBody">
    <div class="twoCol">
      <div>
        <div class="imgBig" id="formImgBox"><span>Photo</span></div>
        <div class="mini">Photo l√©g√®re (‚âà2‚Äì2.5MB).</div>
        <div class="right" style="margin-top:10px">
          <input type="file" id="photo" accept="image/*"/>
          <button class="btn" id="btnRemovePhoto" type="button">Retirer</button>
        </div>
        <div class="divider"></div>
        <label class="mini"><input type="checkbox" id="autoMacros" checked> Calcul auto des macros</label>
      </div>
      <div>
        <label>Titre</label><input id="f_name" type="text">
        <div class="twoCol" style="gap:10px">
          <div><label>Cat√©gorie</label><select id="f_mainCat"></select></div>
          <div><label>Sous-cat√©gorie</label><select id="f_subCat"></select></div>
        </div>
        <div class="twoCol" style="gap:10px; margin-top:10px">
          <div><label>Difficult√©</label><select id="f_diff"><option>Facile</option><option>Moyen</option><option>Difficile</option></select></div>
          <div><label>Temps (min)</label><input id="f_time" type="number" min="0" step="1"></div>
        </div>
        <div class="twoCol" style="gap:10px; margin-top:10px">
          <div><label>Portions</label><input id="f_serv" type="number" min="1" step="1" value="1"></div>
          <div></div>
        </div>
        <div class="twoCol" style="gap:10px; margin-top:10px">
          <div><label>kcal</label><input id="f_kcal" type="number"></div>
          <div><label>Prot√©ines</label><input id="f_p" type="number" step="0.1"></div>
        </div>
        <div class="twoCol" style="gap:10px; margin-top:10px">
          <div><label>Glucides</label><input id="f_c" type="number" step="0.1"></div>
          <div><label>Lipides</label><input id="f_f" type="number" step="0.1"></div>
        </div>
        <label style="margin-top:10px">Notes</label><textarea id="f_notes"></textarea>
      </div>
    </div>

    <div class="divider"></div>
    <div class="right" style="justify-content:space-between">
      <div class="mini">Ingr√©dients (grammes) ‚Ä¢ Base aliments: <strong>226</strong></div>
      <button class="btn" id="btnAddIng" type="button">Ôºã</button>
    </div>

    <div style="margin-top:10px; overflow:auto">
      <table>
        <thead><tr><th>Aliment</th><th>g</th><th>Label (option)</th><th>Note</th><th></th></tr></thead>
        <tbody id="ingBody"></tbody>
      </table>
    </div>

    <div class="divider"></div>
    <label>Instructions</label><textarea id="f_steps"></textarea>
  </div>
</div></div>

<!-- IMPORT -->
<div class="overlay" id="overlayImport"><div class="modal">
  <div class="modalHeader"><div class="modalTitle">Import Word / Texte</div>
    <div class="right"><button class="btn primary" id="btnDoImport">Importer</button><button class="btn" id="btnCloseImport">‚úï</button></div>
  </div>
  <div class="modalBody">
    <pre class="panel" style="white-space:pre-wrap; padding:12px; border-radius:16px; overflow:auto">Nom: ...
Ingr√©dients:
1 oeuf
1 yaourt
1 c√†s huile d'olive
150 g poulet
70 g riz basmati
Instructions:
1) ...</pre>
    <label>Colle ton texte</label><textarea id="importText"></textarea>
    <div class="divider"></div>
    <div class="mini"><strong>Non reconnus / ambigu :</strong></div>
    <div class="mini" id="importUnknown">‚Äî</div>
  </div>
</div></div>

<!-- FOODS -->
<div class="overlay" id="overlayFoods"><div class="modal">
  <div class="modalHeader"><div class="modalTitle">Aliments (par 100g) ‚Ä¢ 226</div>
    <div class="right"><button class="btn primary" id="btnAddFood">Ôºã</button><button class="btn" id="btnCloseFoods">‚úï</button></div>
  </div>
  <div class="modalBody" id="foodsBody"></div>
</div></div>

<div class="toast" id="toast"></div>

<script>
const EDIT_PIN="1234";
const STORAGE_KEY="recipes_premium_V4_compact_v1";
const FOODS_KEY="foods_premium_V4_compact_v1";

const MAIN_CATS=["Healthy","Gourmand"];
const SUB_CATS=["Entr√©e","Plat","Dessert","Bakery"];
const DEFAULT_FOODS=[{"id": "poulet_blanc_cru_000", "name": "Poulet (blanc, cru)", "kcal": 120, "p": 23, "c": 0, "f": 2.6}, {"id": "poulet_cuit_001", "name": "Poulet (cuit)", "kcal": 165, "p": 31, "c": 0, "f": 3.6}, {"id": "dinde_002", "name": "Dinde", "kcal": 110, "p": 24, "c": 0, "f": 1.5}, {"id": "boeuf_steak_5_003", "name": "Boeuf (steak 5%)", "kcal": 137, "p": 21, "c": 0, "f": 5}, {"id": "boeuf_hach√©_15_004", "name": "Boeuf (hach√© 15%)", "kcal": 215, "p": 19, "c": 0, "f": 15}, {"id": "veau_005", "name": "Veau", "kcal": 172, "p": 20, "c": 0, "f": 8}, {"id": "porc_filet_006", "name": "Porc (filet)", "kcal": 143, "p": 21, "c": 0, "f": 5}, {"id": "jambon_blanc_007", "name": "Jambon blanc", "kcal": 115, "p": 19, "c": 1, "f": 4}, {"id": "jambon_cru_008", "name": "Jambon cru", "kcal": 241, "p": 28, "c": 0, "f": 14}, {"id": "lardons_009", "name": "Lardons", "kcal": 305, "p": 16, "c": 1, "f": 27}, {"id": "bacon_010", "name": "Bacon", "kcal": 541, "p": 37, "c": 1.4, "f": 42}, {"id": "saucisse_011", "name": "Saucisse", "kcal": 301, "p": 14, "c": 2, "f": 27}, {"id": "chorizo_012", "name": "Chorizo", "kcal": 455, "p": 24, "c": 2, "f": 38}, {"id": "d√©s_de_tofu_fum√©_013", "name": "D√©s de tofu fum√©", "kcal": 150, "p": 16, "c": 2, "f": 9}, {"id": "tofu_nature_014", "name": "Tofu nature", "kcal": 120, "p": 13, "c": 2, "f": 7}, {"id": "tempeh_015", "name": "Tempeh", "kcal": 193, "p": 20, "c": 9, "f": 11}, {"id": "seitan_016", "name": "Seitan", "kcal": 140, "p": 28, "c": 5, "f": 1.5}, {"id": "oeuf_entier_017", "name": "Oeuf entier", "kcal": 143, "p": 13, "c": 1, "f": 10}, {"id": "blanc_d_oeuf_018", "name": "Blanc d'oeuf", "kcal": 52, "p": 11, "c": 0.7, "f": 0.2}, {"id": "jaune_d_oeuf_019", "name": "Jaune d'oeuf", "kcal": 322, "p": 16, "c": 4, "f": 27}, {"id": "saumon_020", "name": "Saumon", "kcal": 208, "p": 20, "c": 0, "f": 13}, {"id": "saumon_fum√©_021", "name": "Saumon fum√©", "kcal": 117, "p": 18, "c": 0, "f": 4.3}, {"id": "thon_au_naturel_022", "name": "Thon (au naturel)", "kcal": 116, "p": 26, "c": 0, "f": 1}, {"id": "thon_√†_l_huile_√©goutt√©_023", "name": "Thon (√† l'huile, √©goutt√©)", "kcal": 198, "p": 25, "c": 0, "f": 11}, {"id": "cabillaud_024", "name": "Cabillaud", "kcal": 82, "p": 18, "c": 0, "f": 0.7}, {"id": "colin_025", "name": "Colin", "kcal": 90, "p": 19, "c": 0, "f": 1}, {"id": "sardines_026", "name": "Sardines", "kcal": 208, "p": 25, "c": 0, "f": 11}, {"id": "maquereau_027", "name": "Maquereau", "kcal": 205, "p": 19, "c": 0, "f": 14}, {"id": "crevettes_028", "name": "Crevettes", "kcal": 99, "p": 24, "c": 0.2, "f": 0.3}, {"id": "moules_029", "name": "Moules", "kcal": 86, "p": 12, "c": 4, "f": 2}, {"id": "skyr_0_030", "name": "Skyr 0%", "kcal": 60, "p": 11, "c": 4, "f": 0.2}, {"id": "fromage_blanc_0_031", "name": "Fromage blanc 0%", "kcal": 46, "p": 8, "c": 4, "f": 0.2}, {"id": "fromage_blanc_3_032", "name": "Fromage blanc 3%", "kcal": 74, "p": 7, "c": 4, "f": 3}, {"id": "yaourt_grec_0_033", "name": "Yaourt grec 0%", "kcal": 59, "p": 10, "c": 3.6, "f": 0.4}, {"id": "yaourt_nature_034", "name": "Yaourt nature", "kcal": 61, "p": 3.5, "c": 4.7, "f": 3.3}, {"id": "lait_√©cr√©m√©_035", "name": "Lait √©cr√©m√©", "kcal": 34, "p": 3.4, "c": 5, "f": 0.1}, {"id": "lait_demi_√©cr√©m√©_036", "name": "Lait demi-√©cr√©m√©", "kcal": 47, "p": 3.4, "c": 4.8, "f": 1.6}, {"id": "lait_entier_037", "name": "Lait entier", "kcal": 64, "p": 3.3, "c": 4.8, "f": 3.6}, {"id": "lait_d_amande_sans_sucre_038", "name": "Lait d'amande (sans sucre)", "kcal": 13, "p": 0.4, "c": 0.2, "f": 1.1}, {"id": "lait_de_soja_039", "name": "Lait de soja", "kcal": 45, "p": 3.6, "c": 2.5, "f": 2}, {"id": "lait_de_coco_040", "name": "Lait de coco", "kcal": 190, "p": 2, "c": 3, "f": 19}, {"id": "cottage_cheese_041", "name": "Cottage cheese", "kcal": 98, "p": 11, "c": 3.4, "f": 4.3}, {"id": "ricotta_042", "name": "Ricotta", "kcal": 174, "p": 11.3, "c": 3, "f": 13}, {"id": "mozzarella_043", "name": "Mozzarella", "kcal": 280, "p": 19, "c": 2, "f": 22}, {"id": "emmental_044", "name": "Emmental", "kcal": 380, "p": 28, "c": 0, "f": 29}, {"id": "parmesan_045", "name": "Parmesan", "kcal": 431, "p": 38, "c": 4, "f": 29}, {"id": "feta_046", "name": "Feta", "kcal": 264, "p": 14, "c": 4, "f": 21}, {"id": "ch√®vre_047", "name": "Ch√®vre", "kcal": 364, "p": 22, "c": 2, "f": 30}, {"id": "cr√®me_fra√Æche_30_048", "name": "Cr√®me fra√Æche 30%", "kcal": 300, "p": 2, "c": 3, "f": 30}, {"id": "cr√®me_liquide_15_049", "name": "Cr√®me liquide 15%", "kcal": 170, "p": 2.8, "c": 3.3, "f": 15}, {"id": "beurre_050", "name": "Beurre", "kcal": 717, "p": 1, "c": 0, "f": 81}, {"id": "riz_basmati_cru_051", "name": "Riz basmati (cru)", "kcal": 360, "p": 7, "c": 80, "f": 1}, {"id": "riz_basmati_cuit_052", "name": "Riz basmati (cuit)", "kcal": 130, "p": 2.7, "c": 28, "f": 0.3}, {"id": "riz_complet_cru_053", "name": "Riz complet (cru)", "kcal": 370, "p": 7.5, "c": 77, "f": 2.8}, {"id": "riz_complet_cuit_054", "name": "Riz complet (cuit)", "kcal": 111, "p": 2.6, "c": 23, "f": 0.9}, {"id": "p√¢tes_crues_055", "name": "P√¢tes (crues)", "kcal": 350, "p": 12, "c": 72, "f": 1.5}, {"id": "p√¢tes_cuites_056", "name": "P√¢tes (cuites)", "kcal": 158, "p": 5.8, "c": 30, "f": 0.9}, {"id": "p√¢tes_compl√®tes_crues_057", "name": "P√¢tes compl√®tes (crues)", "kcal": 350, "p": 13, "c": 67, "f": 2.5}, {"id": "quinoa_cru_058", "name": "Quinoa (cru)", "kcal": 368, "p": 14, "c": 64, "f": 6}, {"id": "quinoa_cuit_059", "name": "Quinoa (cuit)", "kcal": 120, "p": 4.4, "c": 21, "f": 1.9}, {"id": "boulgour_cru_060", "name": "Boulgour (cru)", "kcal": 342, "p": 12, "c": 76, "f": 1.3}, {"id": "boulgour_cuit_061", "name": "Boulgour (cuit)", "kcal": 83, "p": 3.1, "c": 19, "f": 0.2}, {"id": "semoule_crue_062", "name": "Semoule (crue)", "kcal": 376, "p": 12.8, "c": 77, "f": 0.6}, {"id": "couscous_cuit_063", "name": "Couscous (cuit)", "kcal": 112, "p": 3.8, "c": 23, "f": 0.2}, {"id": "avoine_flocons_064", "name": "Avoine (flocons)", "kcal": 389, "p": 17, "c": 66, "f": 7}, {"id": "farine_de_bl√©_065", "name": "Farine de bl√©", "kcal": 364, "p": 10, "c": 76, "f": 1}, {"id": "farine_compl√®te_066", "name": "Farine compl√®te", "kcal": 340, "p": 13, "c": 72, "f": 2.5}, {"id": "ma√Øzena_067", "name": "Ma√Øzena", "kcal": 381, "p": 0.3, "c": 91, "f": 0.1}, {"id": "pain_blanc_068", "name": "Pain blanc", "kcal": 265, "p": 9, "c": 49, "f": 3.2}, {"id": "pain_complet_069", "name": "Pain complet", "kcal": 247, "p": 9, "c": 41, "f": 4.2}, {"id": "pain_de_mie_070", "name": "Pain de mie", "kcal": 265, "p": 9, "c": 49, "f": 3.5}, {"id": "pain_au_levain_071", "name": "Pain au levain", "kcal": 289, "p": 10, "c": 56, "f": 1.5}, {"id": "wrap_tortilla_072", "name": "Wrap / tortilla", "kcal": 310, "p": 8, "c": 52, "f": 7}, {"id": "pita_073", "name": "Pita", "kcal": 275, "p": 9, "c": 55, "f": 1.2}, {"id": "bagel_074", "name": "Bagel", "kcal": 250, "p": 10, "c": 48, "f": 2}, {"id": "brioche_075", "name": "Brioche", "kcal": 330, "p": 8, "c": 51, "f": 11}, {"id": "croissant_076", "name": "Croissant", "kcal": 406, "p": 8, "c": 45, "f": 21}, {"id": "p√¢te_feuillet√©e_077", "name": "P√¢te feuillet√©e", "kcal": 558, "p": 7, "c": 45, "f": 38}, {"id": "p√¢te_bris√©e_078", "name": "P√¢te bris√©e", "kcal": 440, "p": 7, "c": 45, "f": 28}, {"id": "p√¢te_√†_pizza_079", "name": "P√¢te √† pizza", "kcal": 270, "p": 8.5, "c": 52, "f": 3.5}, {"id": "gnocchi_080", "name": "Gnocchi", "kcal": 150, "p": 3, "c": 33, "f": 0.7}, {"id": "polenta_cuite_081", "name": "Polenta (cuite)", "kcal": 80, "p": 1.6, "c": 17, "f": 0.3}, {"id": "pommes_de_terre_082", "name": "Pommes de terre", "kcal": 77, "p": 2, "c": 17, "f": 0.1}, {"id": "pommes_de_terre_cuites_083", "name": "Pommes de terre (cuites)", "kcal": 87, "p": 2, "c": 20, "f": 0.1}, {"id": "patate_douce_084", "name": "Patate douce", "kcal": 86, "p": 1.6, "c": 20, "f": 0.1}, {"id": "lentilles_cuites_085", "name": "Lentilles (cuites)", "kcal": 116, "p": 9, "c": 20, "f": 0.4}, {"id": "pois_chiches_cuits_086", "name": "Pois chiches (cuits)", "kcal": 164, "p": 9, "c": 27, "f": 2.6}, {"id": "haricots_rouges_cuits_087", "name": "Haricots rouges (cuits)", "kcal": 127, "p": 9, "c": 23, "f": 0.5}, {"id": "haricots_blancs_cuits_088", "name": "Haricots blancs (cuits)", "kcal": 114, "p": 7.7, "c": 21, "f": 0.5}, {"id": "edamame_089", "name": "Edamame", "kcal": 122, "p": 11.9, "c": 9.9, "f": 5.2}, {"id": "banane_090", "name": "Banane", "kcal": 89, "p": 1.1, "c": 23, "f": 0.3}, {"id": "pomme_091", "name": "Pomme", "kcal": 52, "p": 0.3, "c": 14, "f": 0.2}, {"id": "poire_092", "name": "Poire", "kcal": 57, "p": 0.4, "c": 15, "f": 0.1}, {"id": "fraise_093", "name": "Fraise", "kcal": 32, "p": 0.7, "c": 7.7, "f": 0.3}, {"id": "myrtille_094", "name": "Myrtille", "kcal": 57, "p": 0.7, "c": 14.5, "f": 0.3}, {"id": "framboise_095", "name": "Framboise", "kcal": 52, "p": 1.2, "c": 12, "f": 0.7}, {"id": "mangue_096", "name": "Mangue", "kcal": 60, "p": 0.8, "c": 15, "f": 0.4}, {"id": "ananas_097", "name": "Ananas", "kcal": 50, "p": 0.5, "c": 13, "f": 0.1}, {"id": "orange_098", "name": "Orange", "kcal": 47, "p": 0.9, "c": 12, "f": 0.1}, {"id": "citron_099", "name": "Citron", "kcal": 29, "p": 1.1, "c": 9, "f": 0.3}, {"id": "kiwi_100", "name": "Kiwi", "kcal": 61, "p": 1.1, "c": 15, "f": 0.5}, {"id": "raisin_101", "name": "Raisin", "kcal": 69, "p": 0.7, "c": 18, "f": 0.2}, {"id": "raisin_sec_102", "name": "Raisin sec", "kcal": 299, "p": 3.1, "c": 79, "f": 0.5}, {"id": "dattes_103", "name": "Dattes", "kcal": 282, "p": 2.5, "c": 75, "f": 0.4}, {"id": "abricot_104", "name": "Abricot", "kcal": 48, "p": 1.4, "c": 11, "f": 0.4}, {"id": "p√™che_105", "name": "P√™che", "kcal": 39, "p": 0.9, "c": 10, "f": 0.3}, {"id": "past√®que_106", "name": "Past√®que", "kcal": 30, "p": 0.6, "c": 8, "f": 0.2}, {"id": "avocat_107", "name": "Avocat", "kcal": 160, "p": 2, "c": 9, "f": 15}, {"id": "tomate_108", "name": "Tomate", "kcal": 18, "p": 0.9, "c": 3.9, "f": 0.2}, {"id": "sauce_tomate_109", "name": "Sauce tomate", "kcal": 29, "p": 1.4, "c": 6.2, "f": 0.2}, {"id": "concombre_110", "name": "Concombre", "kcal": 15, "p": 0.7, "c": 3.6, "f": 0.1}, {"id": "courgette_111", "name": "Courgette", "kcal": 17, "p": 1.2, "c": 3.1, "f": 0.3}, {"id": "carotte_112", "name": "Carotte", "kcal": 41, "p": 0.9, "c": 9.6, "f": 0.2}, {"id": "poivron_113", "name": "Poivron", "kcal": 31, "p": 1.0, "c": 6.0, "f": 0.3}, {"id": "oignon_114", "name": "Oignon", "kcal": 40, "p": 1.1, "c": 9.3, "f": 0.1}, {"id": "ail_115", "name": "Ail", "kcal": 149, "p": 6.4, "c": 33, "f": 0.5}, {"id": "brocoli_116", "name": "Brocoli", "kcal": 34, "p": 2.8, "c": 6.6, "f": 0.4}, {"id": "epinards_117", "name": "Epinards", "kcal": 23, "p": 2.9, "c": 1.4, "f": 0.4}, {"id": "champignons_118", "name": "Champignons", "kcal": 22, "p": 3.1, "c": 3.3, "f": 0.3}, {"id": "chou_fleur_119", "name": "Chou-fleur", "kcal": 25, "p": 1.9, "c": 5, "f": 0.3}, {"id": "chou_120", "name": "Chou", "kcal": 25, "p": 1.3, "c": 6, "f": 0.1}, {"id": "chou_rouge_121", "name": "Chou rouge", "kcal": 31, "p": 1.4, "c": 7.4, "f": 0.2}, {"id": "aubergine_122", "name": "Aubergine", "kcal": 25, "p": 1, "c": 6, "f": 0.2}, {"id": "haricots_verts_123", "name": "Haricots verts", "kcal": 31, "p": 1.8, "c": 7, "f": 0.1}, {"id": "petits_pois_124", "name": "Petits pois", "kcal": 81, "p": 5.4, "c": 14.5, "f": 0.4}, {"id": "ma√Øs_125", "name": "Ma√Øs", "kcal": 86, "p": 3.4, "c": 19, "f": 1.2}, {"id": "ma√Øs_bo√Æte_126", "name": "Ma√Øs (bo√Æte)", "kcal": 78, "p": 2.5, "c": 15, "f": 1.2}, {"id": "betterave_127", "name": "Betterave", "kcal": 43, "p": 1.6, "c": 10, "f": 0.2}, {"id": "salade_128", "name": "Salade", "kcal": 15, "p": 1.4, "c": 2.9, "f": 0.2}, {"id": "roquette_129", "name": "Roquette", "kcal": 25, "p": 2.6, "c": 3.7, "f": 0.7}, {"id": "c√©leri_130", "name": "C√©leri", "kcal": 16, "p": 0.7, "c": 3, "f": 0.2}, {"id": "poireau_131", "name": "Poireau", "kcal": 61, "p": 1.5, "c": 14, "f": 0.3}, {"id": "asperges_132", "name": "Asperges", "kcal": 20, "p": 2.2, "c": 3.9, "f": 0.1}, {"id": "huile_d_olive_133", "name": "Huile d'olive", "kcal": 884, "p": 0, "c": 0, "f": 100}, {"id": "huile_de_coco_134", "name": "Huile de coco", "kcal": 892, "p": 0, "c": 0, "f": 100}, {"id": "huile_de_colza_135", "name": "Huile de colza", "kcal": 884, "p": 0, "c": 0, "f": 100}, {"id": "amandes_136", "name": "Amandes", "kcal": 579, "p": 21, "c": 22, "f": 50}, {"id": "noix_137", "name": "Noix", "kcal": 654, "p": 15, "c": 14, "f": 65}, {"id": "noisettes_138", "name": "Noisettes", "kcal": 628, "p": 15, "c": 17, "f": 61}, {"id": "cacahu√®tes_139", "name": "Cacahu√®tes", "kcal": 567, "p": 26, "c": 16, "f": 49}, {"id": "beurre_de_cacahu√®te_140", "name": "Beurre de cacahu√®te", "kcal": 588, "p": 25, "c": 20, "f": 50}, {"id": "graines_de_chia_141", "name": "Graines de chia", "kcal": 486, "p": 17, "c": 42, "f": 31}, {"id": "graines_de_lin_142", "name": "Graines de lin", "kcal": 534, "p": 18, "c": 29, "f": 42}, {"id": "graines_de_tournesol_143", "name": "Graines de tournesol", "kcal": 584, "p": 21, "c": 20, "f": 51}, {"id": "sucre_144", "name": "Sucre", "kcal": 400, "p": 0, "c": 100, "f": 0}, {"id": "cassonade_145", "name": "Cassonade", "kcal": 380, "p": 0, "c": 98, "f": 0}, {"id": "sirop_d_√©rable_146", "name": "Sirop d'√©rable", "kcal": 260, "p": 0, "c": 67, "f": 0.1}, {"id": "confiture_147", "name": "Confiture", "kcal": 250, "p": 0.4, "c": 60, "f": 0.2}, {"id": "chocolat_au_lait_148", "name": "Chocolat au lait", "kcal": 535, "p": 7.7, "c": 59, "f": 30}, {"id": "p√©pites_chocolat_149", "name": "P√©pites chocolat", "kcal": 520, "p": 6, "c": 55, "f": 30}, {"id": "cacao_non_sucr√©_150", "name": "Cacao non sucr√©", "kcal": 228, "p": 20, "c": 58, "f": 14}, {"id": "levure_chimique_151", "name": "Levure chimique", "kcal": 53, "p": 0, "c": 28, "f": 0}, {"id": "levure_boulang√®re_152", "name": "Levure boulang√®re", "kcal": 325, "p": 40, "c": 41, "f": 8}, {"id": "bicarbonate_153", "name": "Bicarbonate", "kcal": 0, "p": 0, "c": 0, "f": 0}, {"id": "g√©latine_154", "name": "G√©latine", "kcal": 335, "p": 85, "c": 0, "f": 0}, {"id": "extrait_de_vanille_155", "name": "Extrait de vanille", "kcal": 288, "p": 0, "c": 13, "f": 0}, {"id": "sauce_soja_156", "name": "Sauce soja", "kcal": 53, "p": 8.1, "c": 4.9, "f": 0.6}, {"id": "ketchup_157", "name": "Ketchup", "kcal": 112, "p": 1.3, "c": 26, "f": 0.2}, {"id": "moutarde_158", "name": "Moutarde", "kcal": 66, "p": 4.4, "c": 5.8, "f": 3.7}, {"id": "mayonnaise_159", "name": "Mayonnaise", "kcal": 680, "p": 1, "c": 1, "f": 75}, {"id": "pesto_160", "name": "Pesto", "kcal": 460, "p": 5, "c": 6, "f": 46}, {"id": "sauce_barbecue_161", "name": "Sauce barbecue", "kcal": 180, "p": 0.8, "c": 44, "f": 0.5}, {"id": "sriracha_162", "name": "Sriracha", "kcal": 93, "p": 1.3, "c": 20, "f": 0.9}, {"id": "vinaigre_balsamique_163", "name": "Vinaigre balsamique", "kcal": 88, "p": 0.5, "c": 17, "f": 0.0}, {"id": "vinaigre_164", "name": "Vinaigre", "kcal": 18, "p": 0, "c": 0, "f": 0}, {"id": "olives_165", "name": "Olives", "kcal": 145, "p": 1, "c": 3.8, "f": 15.3}, {"id": "cornichons_166", "name": "Cornichons", "kcal": 12, "p": 0.5, "c": 2.3, "f": 0.2}, {"id": "c√¢pres_167", "name": "C√¢pres", "kcal": 23, "p": 2.4, "c": 4.9, "f": 0.9}, {"id": "whey_168", "name": "Whey", "kcal": 400, "p": 80, "c": 8, "f": 6}, {"id": "barre_prot√©in√©e_169", "name": "Barre prot√©in√©e", "kcal": 350, "p": 30, "c": 35, "f": 10}, {"id": "granola_170", "name": "Granola", "kcal": 450, "p": 10, "c": 60, "f": 15}, {"id": "riz_souffl√©_171", "name": "Riz souffl√©", "kcal": 402, "p": 6, "c": 90, "f": 1}, {"id": "sel_172", "name": "Sel", "kcal": 0, "p": 0, "c": 0, "f": 0}, {"id": "poivre_173", "name": "Poivre", "kcal": 0, "p": 0, "c": 0, "f": 0}, {"id": "paprika_174", "name": "Paprika", "kcal": 0, "p": 0, "c": 0, "f": 0}, {"id": "cumin_175", "name": "Cumin", "kcal": 0, "p": 0, "c": 0, "f": 0}, {"id": "curry_poudre_176", "name": "Curry (poudre)", "kcal": 0, "p": 0, "c": 0, "f": 0}, {"id": "cannelle_177", "name": "Cannelle", "kcal": 0, "p": 0, "c": 0, "f": 0}, {"id": "piment_178", "name": "Piment", "kcal": 0, "p": 0, "c": 0, "f": 0}, {"id": "gingembre_179", "name": "Gingembre", "kcal": 0, "p": 0, "c": 0, "f": 0}, {"id": "curcuma_180", "name": "Curcuma", "kcal": 0, "p": 0, "c": 0, "f": 0}, {"id": "basilic_181", "name": "Basilic", "kcal": 0, "p": 0, "c": 0, "f": 0}, {"id": "persil_182", "name": "Persil", "kcal": 0, "p": 0, "c": 0, "f": 0}, {"id": "coriandre_183", "name": "Coriandre", "kcal": 0, "p": 0, "c": 0, "f": 0}, {"id": "pamplemousse_184", "name": "Pamplemousse", "kcal": 55, "p": 0.8, "c": 14, "f": 0.3}, {"id": "grenade_185", "name": "Grenade", "kcal": 55, "p": 0.8, "c": 14, "f": 0.3}, {"id": "prune_186", "name": "Prune", "kcal": 55, "p": 0.8, "c": 14, "f": 0.3}, {"id": "cerise_187", "name": "Cerise", "kcal": 55, "p": 0.8, "c": 14, "f": 0.3}, {"id": "melon_188", "name": "Melon", "kcal": 55, "p": 0.8, "c": 14, "f": 0.3}, {"id": "nectarine_189", "name": "Nectarine", "kcal": 55, "p": 0.8, "c": 14, "f": 0.3}, {"id": "figue_190", "name": "Figue", "kcal": 55, "p": 0.8, "c": 14, "f": 0.3}, {"id": "chou_kale_191", "name": "Chou kale", "kcal": 35, "p": 2, "c": 7, "f": 0.4}, {"id": "radis_192", "name": "Radis", "kcal": 35, "p": 2, "c": 7, "f": 0.4}, {"id": "navet_193", "name": "Navet", "kcal": 35, "p": 2, "c": 7, "f": 0.4}, {"id": "fenouil_194", "name": "Fenouil", "kcal": 35, "p": 2, "c": 7, "f": 0.4}, {"id": "artichaut_195", "name": "Artichaut", "kcal": 35, "p": 2, "c": 7, "f": 0.4}, {"id": "choux_de_bruxelles_196", "name": "Choux de Bruxelles", "kcal": 35, "p": 2, "c": 7, "f": 0.4}, {"id": "concentr√©_de_tomate_197", "name": "Concentr√© de tomate", "kcal": 35, "p": 2, "c": 7, "f": 0.4}, {"id": "k√©fir_198", "name": "K√©fir", "kcal": 45, "p": 3.4, "c": 4.8, "f": 1.0}, {"id": "lait_ferment√©_199", "name": "Lait ferment√©", "kcal": 45, "p": 3.4, "c": 4.8, "f": 1.0}, {"id": "fromage_frais_200", "name": "Fromage frais", "kcal": 342, "p": 6, "c": 4, "f": 34}, {"id": "philadelphia_201", "name": "Philadelphia", "kcal": 342, "p": 6, "c": 4, "f": 34}, {"id": "mascarpone_202", "name": "Mascarpone", "kcal": 420, "p": 6, "c": 4, "f": 42}, {"id": "biscottes_203", "name": "Biscottes", "kcal": 410, "p": 10, "c": 75, "f": 8}, {"id": "crackers_204", "name": "Crackers", "kcal": 410, "p": 10, "c": 75, "f": 8}, {"id": "c√©r√©ales_205", "name": "C√©r√©ales", "kcal": 380, "p": 8, "c": 80, "f": 2}, {"id": "muesli_206", "name": "Muesli", "kcal": 360, "p": 10, "c": 65, "f": 7}, {"id": "tortellini_207", "name": "Tortellini", "kcal": 300, "p": 12, "c": 45, "f": 8}, {"id": "nouilles_crues_208", "name": "Nouilles (crues)", "kcal": 360, "p": 11, "c": 72, "f": 2}, {"id": "nouilles_cuites_209", "name": "Nouilles (cuites)", "kcal": 138, "p": 4.5, "c": 25, "f": 1}, {"id": "ramen_nouilles_210", "name": "Ramen (nouilles)", "kcal": 360, "p": 11, "c": 72, "f": 2}, {"id": "poulet_r√¥ti_211", "name": "Poulet r√¥ti", "kcal": 190, "p": 29, "c": 0, "f": 7}, {"id": "steak_de_soja_212", "name": "Steak de soja", "kcal": 170, "p": 17, "c": 7, "f": 7}, {"id": "prot√©ines_de_soja_textur√©es_213", "name": "Prot√©ines de soja textur√©es", "kcal": 330, "p": 50, "c": 30, "f": 1.5}, {"id": "surimi_214", "name": "Surimi", "kcal": 99, "p": 8, "c": 15, "f": 0.9}, {"id": "calamar_215", "name": "Calamar", "kcal": 92, "p": 16, "c": 3, "f": 1.4}, {"id": "compote_sans_sucre_216", "name": "Compote sans sucre", "kcal": 42, "p": 0.2, "c": 10, "f": 0.1}, {"id": "p√¢te_√†_tartiner_217", "name": "P√¢te √† tartiner", "kcal": 540, "p": 7, "c": 57, "f": 32}, {"id": "biscuit_218", "name": "Biscuit", "kcal": 480, "p": 6, "c": 65, "f": 20}, {"id": "cookie_219", "name": "Cookie", "kcal": 480, "p": 6, "c": 65, "f": 20}, {"id": "g√¢teau_nature_220", "name": "G√¢teau nature", "kcal": 350, "p": 6, "c": 55, "f": 12}, {"id": "sauce_s√©same_221", "name": "Sauce s√©same", "kcal": 595, "p": 17, "c": 21, "f": 54}, {"id": "tahini_222", "name": "Tahini", "kcal": 595, "p": 17, "c": 21, "f": 54}, {"id": "sauce_au_yaourt_223", "name": "Sauce au yaourt", "kcal": 80, "p": 4, "c": 6, "f": 4}, {"id": "sauce_curry_224", "name": "Sauce curry", "kcal": 120, "p": 2, "c": 12, "f": 6}, {"id": "sauce_pesto_rouge_225", "name": "Sauce pesto rouge", "kcal": 420, "p": 5, "c": 8, "f": 40}];

const $=(s)=>document.querySelector(s);
function uid(){return Math.random().toString(16).slice(2)+Date.now().toString(16);}
function escapeHtml(s){return (s||"").toString().replaceAll("&","&amp;").replaceAll("<","&lt;").replaceAll(">","&gt;").replaceAll('"',"&quot;").replaceAll("'","&#039;");}
function normalize(s){return (s||"").toString().toLowerCase().normalize("NFD").replace(/[\u0300-\u036f]/g,"").replace(/[^a-z0-9\s]/g," ").replace(/\s+/g," ").trim();}
function fmt1(n){n=Number(n||0);return (Math.round(n*10)/10).toString();}
function showToast(msg){const t=$("#toast");t.textContent=msg;t.style.display="block";clearTimeout(showToast._t);showToast._t=setTimeout(()=>t.style.display="none",1700);}

function loadFoods(){try{const raw=localStorage.getItem(FOODS_KEY);if(!raw){localStorage.setItem(FOODS_KEY,JSON.stringify(DEFAULT_FOODS));return DEFAULT_FOODS.slice();}const arr=JSON.parse(raw);return Array.isArray(arr)?arr:DEFAULT_FOODS.slice();}catch(e){return DEFAULT_FOODS.slice();}}
let foods=loadFoods();
function saveFoods(){localStorage.setItem(FOODS_KEY,JSON.stringify(foods));}
function foodById(id){return foods.find(f=>f.id===id)||null;}
function foodName(id){const f=foodById(id);return f?f.name:"";}

function seedRecipes(){const chicken=foods.find(x=>x.name.includes("Poulet"))?.id||foods[0].id;const rice=foods.find(x=>x.name.includes("Riz basmati (cru)"))?.id||foods[0].id;const spin=foods.find(x=>x.name.includes("Epinards"))?.id||foods[0].id;
return [{id:uid(),name:"Bowl poulet curry",mainCat:"Healthy",subCat:"Plat",difficulty:"Facile",timeMin:20,servings:1,kcal:0,p:0,c:0,f:0,autoMacros:true,photo:null,
ingredients:[{foodId:chicken,grams:150,label:"Poulet",note:""},{foodId:rice,grams:70,label:"Riz basmati",note:""},{foodId:spin,grams:100,label:"√âpinards",note:""}],
steps:"1) Cuire le riz.\n2) Cuire le poulet.\n3) M√©langer et servir.",notes:"",createdAt:Date.now()-1000*60*60*12,updatedAt:Date.now()-1000*60*60*12}];}

function loadState(){try{const raw=localStorage.getItem(STORAGE_KEY);if(!raw)return{recipes:seedRecipes()};const obj=JSON.parse(raw);if(!obj.recipes)obj.recipes=[];return obj;}catch(e){return{recipes:seedRecipes()};}}
let state=loadState();
function saveState(){localStorage.setItem(STORAGE_KEY,JSON.stringify(state));}
function migrate(r){if(!r.mainCat)r.mainCat=MAIN_CATS.includes(r.category)?r.category:"Healthy";if(!r.subCat)r.subCat=SUB_CATS.includes(r.subcategory)?r.subcategory:"Plat";if(r.autoMacros===undefined)r.autoMacros=true;return r;}
state.recipes=(state.recipes||[]).map(migrate);saveState();

function calcTotals(ings){let kcal=0,p=0,c=0,f=0;for(const it of (ings||[])){const grams=Number(it.grams||0);if(!grams||grams<=0)continue;const food=foodById(it.foodId);if(!food)continue;const m=grams/100;kcal+=(Number(food.kcal)||0)*m;p+=(Number(food.p)||0)*m;c+=(Number(food.c)||0)*m;f+=(Number(food.f)||0)*m;}return{kcal,p,c,f};}
function ensureAuto(){for(const r of state.recipes){if(r.autoMacros){const t=calcTotals(r.ingredients||[]);r.kcal=Math.round(t.kcal);r.p=Math.round(t.p*10)/10;r.c=Math.round(t.c*10)/10;r.f=Math.round(t.f*10)/10;}}saveState();}ensureAuto();

function levenshtein(a,b){a=a||"";b=b||"";const m=a.length,n=b.length;if(!m)return n;if(!n)return m;const dp=new Array(n+1);for(let j=0;j<=n;j++)dp[j]=j;for(let i=1;i<=m;i++){let prev=dp[0];dp[0]=i;for(let j=1;j<=n;j++){const tmp=dp[j];const cost=a[i-1]===b[j-1]?0:1;dp[j]=Math.min(dp[j]+1,dp[j-1]+1,prev+cost);prev=tmp;}}return dp[n];}
function scoreName(query,name){const q=normalize(query),t=normalize(name);if(!q||!t)return-999;let score=0;if(t.includes(q))score+=80;const qT=q.split(" ").filter(Boolean),tT=t.split(" ").filter(Boolean);for(const qt of qT){if(tT.includes(qt)){score+=35;continue;}let best=999;for(const tt of tT){const d=levenshtein(qt,tt);if(d<best)best=d;if(best===0)break;}if(best===1)score+=18;else if(best===2)score+=10;else if(best===3&&qt.length>=6)score+=6;else score-=4;}return score;}
function bestFoodMatches(name,topN=3){return foods.map(f=>({f,s:scoreName(name,f.name)})).sort((a,b)=>b.s-a.s).filter(x=>x.s>10).slice(0,topN);}
function chooseAmbiguous(matches,original){const opts=matches.map((x,i)=>`${i+1}) ${x.f.name}`).join("\n");const choice=prompt(`Je ne suis pas s√ªr pour: "${original}".\nChoisis :\n${opts}\n\nTape 1-${matches.length} (ou annule)`);const idx=parseInt(choice||"",10);if(!idx||idx<1||idx>matches.length)return null;return matches[idx-1].f;}

function parseIngredientLine(line){const raw=line.trim();if(!raw)return null;const s=raw.replace(/^[-‚Ä¢*\u2022\s]+/,"").trim();
let m=s.match(/^([0-9]+)\s*(oeuf|oeufs)\b/i);if(m){const n=parseInt(m[1]||"1",10);return{name:"Oeuf entier",grams:60*n,raw};}
m=s.match(/^([0-9]+)\s*(yaourt|yahourt)\b/i);if(m){const n=parseInt(m[1]||"1",10);return{name:"Yaourt nature",grams:125*n,raw};}
m=s.match(/^([0-9]+)\s*(c\.\s*a\.\s*s|cas|cuillere\s*a\s*soupe|cuill√®re\s*√†\s*soupe)\s*(.*)$/i);if(m){const n=parseInt(m[1]||"1",10);const name=(m[3]||"").trim()||"Huile d'olive";const grams=name.toLowerCase().includes("huile")?10*n:15*n;return{name,grams,raw};}
m=s.match(/^([0-9]+)\s*(c\.\s*a\.\s*c|cac|cuillere\s*a\s*cafe|cuill√®re\s*√†\s*caf√©)\s*(.*)$/i);if(m){const n=parseInt(m[1]||"1",10);const name=(m[3]||"").trim()||"Sucre";const grams=5*n;return{name,grams,raw};}
m=s.match(/^([0-9]+(?:[\.,][0-9]+)?)\s*(kg|g|gr|grammes|grams|ml|cl|l)\b\s*(.*)$/i);if(m){const num=parseFloat(m[1].replace(",","."));const unit=m[2].toLowerCase();const name=(m[3]||"").trim();let grams=num;if(unit==="kg")grams=num*1000;else if(unit==="l")grams=num*1000;else if(unit==="cl")grams=num*10;else grams=num;return{name,grams:Math.round(grams*10)/10,raw};}
return{name:s,grams:null,raw};}

function parseImportText(text){const t=(text||"").replace(/\r/g,"").trim();if(!t)return null;
const nameMatch=t.match(/(?:^|\n)\s*(?:nom|title)\s*:\s*(.+)\s*(?:\n|$)/i);const name=nameMatch?nameMatch[1].trim():"Recette import√©e";
const ingBlockMatch=t.match(/(?:^|\n)\s*(?:ingredients|ingr[e√©]dients)\s*:\s*([\s\S]*?)(?:\n\s*(?:instructions|preparation|pr√©paration|etapes|√©tapes)\s*:|$)/i);
const instrMatch=t.match(/(?:^|\n)\s*(?:instructions|preparation|pr√©paration|etapes|√©tapes)\s*:\s*([\s\S]*)$/i);
const ingBlock=ingBlockMatch?ingBlockMatch[1].trim():"";const instructions=instrMatch?instrMatch[1].trim():"";
const lines=ingBlock.split("\n").map(x=>x.trim()).filter(Boolean);const parsed=lines.map(parseIngredientLine).filter(Boolean);
const ingredients=[];const unknown=[];
for(const it of parsed){const nm=(it.name||"").trim();if(!nm){unknown.push(it.raw);continue;}
const matches=bestFoodMatches(nm,3);if(!matches.length){unknown.push(it.raw);continue;}
let chosen=matches[0].f;if(matches.length>1 && (matches[0].s-matches[1].s)<8){const pick=chooseAmbiguous(matches,it.raw);if(pick)chosen=pick;else{unknown.push(it.raw);continue;}}
let grams=it.grams;let note="";if(grams==null){grams=100;note="Quantit√© non trouv√©e ‚Üí 100g (√† ajuster)";unknown.push(it.raw+" (quantit√© manquante)");}
ingredients.push({foodId:chosen.id,grams,label:nm,note});
}
return{name,ingredients,instructions,unknown};}

function pill(text,cls=""){return `<span class="pill ${cls}">${escapeHtml(text)}</span>`;}
function recipeSearchText(r){const ing=(r.ingredients||[]).map(i=>`${i.label||""} ${foodName(i.foodId)} ${i.grams||""}`).join(" ");return `${r.name} ${r.mainCat} ${r.subCat} ${r.difficulty} ${ing} ${r.steps||""} ${r.notes||""}`; }
function recipeCardHTML(r){const top=r.photo?`<div class="thumb"><img src="${r.photo}" alt="${escapeHtml(r.name)}"></div>`:`<div class="thumb">${escapeHtml(r.mainCat||"Recette")}</div>`;
const meta=[pill(r.mainCat||"‚Äî","accent"),pill(r.subCat||"‚Äî"),pill(`‚è± ${r.timeMin||0} min`),pill(`‚≠ê ${r.difficulty||"‚Äî"}`,"warn"),pill(`üî• ${Math.round(r.kcal||0)} kcal`),pill(`üí™ ${fmt1(r.p||0)} g P`,"ok")].join("");
return `<div class="card" data-id="${r.id}">${top}<div class="cardBody"><h3 class="name">${escapeHtml(r.name||"Sans titre")}</h3><div class="metaLine">${escapeHtml((r.notes||"").slice(0,92))}${(r.notes||"").length>92?"‚Ä¶":""}</div><div class="smallRow">${meta}</div></div></div>`;}

function renderSelectors(){$("#mainCat").innerHTML=`<option value="">Toutes</option>`+MAIN_CATS.map(c=>`<option value="${escapeHtml(c)}">${escapeHtml(c)}</option>`).join("");$("#subCat").innerHTML=`<option value="">Toutes</option>`+SUB_CATS.map(c=>`<option value="${escapeHtml(c)}">${escapeHtml(c)}</option>`).join("");
$("#f_mainCat").innerHTML=MAIN_CATS.map(c=>`<option value="${escapeHtml(c)}">${escapeHtml(c)}</option>`).join("");$("#f_subCat").innerHTML=SUB_CATS.map(c=>`<option value="${escapeHtml(c)}">${escapeHtml(c)}</option>`).join("");}

function renderStatsHome(){const total=state.recipes.length;const avgK=total?state.recipes.reduce((s,r)=>s+(Number(r.kcal)||0),0)/total:0;const avgP=total?state.recipes.reduce((s,r)=>s+(Number(r.p)||0),0)/total:0;
$("#statsHome").innerHTML=[`<span class="chip" style="cursor:default">üìö ${total} recettes</span>`,`<span class="chip" style="cursor:default">üî• Moy. ${Math.round(avgK)} kcal</span>`,`<span class="chip" style="cursor:default">üí™ Moy. ${Math.round(avgP)} g prot</span>`,`<span class="chip" style="cursor:default">ü•ó ${foods.length} aliments</span>`].join("");}

function renderHome(){renderStatsHome();const main=$("#homeMainCats");main.innerHTML=MAIN_CATS.map(c=>`<span class="chip" data-main="${escapeHtml(c)}">${escapeHtml(c)}</span>`).join("");
main.querySelectorAll("[data-main]").forEach(el=>el.addEventListener("click",()=>{setView("recipes");$("#mainCat").value=el.dataset.main;$("#subCat").value="";renderRecipes();}));
const sub=$("#homeSubCats");sub.innerHTML=SUB_CATS.map(c=>`<span class="chip" data-sub="${escapeHtml(c)}">${escapeHtml(c)}</span>`).join("");
sub.querySelectorAll("[data-sub]").forEach(el=>el.addEventListener("click",()=>{setView("recipes");$("#subCat").value=el.dataset.sub;renderRecipes();}));}

function applyRecipeFilters(){const q=($("#q").value||"").trim();const mainCat=$("#mainCat").value||"";const subCat=$("#subCat").value||"";const diff=$("#diff").value||"";const sort=$("#sort").value||"recent";
let list=state.recipes.slice();if(mainCat)list=list.filter(r=>r.mainCat===mainCat);if(subCat)list=list.filter(r=>r.subCat===subCat);if(diff)list=list.filter(r=>r.difficulty===diff);
if(q){list=list.map(r=>({r,score:scoreName(q,r.name)*1.5+scoreName(q,recipeSearchText(r))})).filter(x=>x.score>5).sort((a,b)=>b.score-a.score).map(x=>x.r);}
const cmp=(a,b)=>(Number(a)||0)-(Number(b)||0);if(sort==="recent")list.sort((a,b)=>(b.updatedAt||0)-(a.updatedAt||0));if(sort==="name")list.sort((a,b)=>(a.name||"").localeCompare(b.name||"","fr"));if(sort==="kcal")list.sort((a,b)=>cmp(a.kcal,b.kcal));if(sort==="protein")list.sort((a,b)=>cmp(b.p,a.p));if(sort==="time")list.sort((a,b)=>cmp(a.timeMin,b.timeMin));return list;}

function renderRecipes(){const list=applyRecipeFilters();const total=list.length;const avgK=total?list.reduce((s,r)=>s+(Number(r.kcal)||0),0)/total:0;const avgP=total?list.reduce((s,r)=>s+(Number(r.p)||0),0)/total:0;
$("#statsRecipes").innerHTML=[`<span class="chip" style="cursor:default">üìö ${total} r√©sultat(s)</span>`,`<span class="chip" style="cursor:default">üî• Moy. ${Math.round(avgK)} kcal</span>`,`<span class="chip" style="cursor:default">üí™ Moy. ${Math.round(avgP)} g prot</span>`].join("");
$("#grid").innerHTML=list.map(recipeCardHTML).join("")||`<div class="mini">Aucun r√©sultat.</div>`;$("#grid").querySelectorAll(".card").forEach(el=>el.addEventListener("click",()=>openRecipe(el.dataset.id)));}

function setView(view){document.querySelectorAll(".tab").forEach(t=>t.classList.toggle("active",t.dataset.view===view));$("#viewHome").style.display=view==="home"?"block":"none";$("#viewRecipes").style.display=view==="recipes"?"block":"none";if(view==="home")renderHome();else renderRecipes();}

// View recipe
let currentId=null, editId=null, formPhoto=null;
function openRecipe(id){const r=state.recipes.find(x=>x.id===id);if(!r)return;currentId=id;$("#viewTitle").textContent=r.name||"Recette";
const img=r.photo?`<div class="imgBig"><img src="${r.photo}"></div>`:`<div class="imgBig"><span>Pas de photo</span></div>`;
const ingRows=(r.ingredients||[]).map(i=>{const f=foodById(i.foodId);const nm=i.label||(f?f.name:"‚Äî");return `<tr><td><strong>${escapeHtml(nm)}</strong><div class="mini">${f?escapeHtml(f.name):"Aliment manquant"}</div></td><td>${escapeHtml(i.grams??"")}</td><td>${escapeHtml(i.note||"")}</td></tr>`;}).join("");
$("#viewBody").innerHTML=`<div class="twoCol"><div>${img}<div class="smallRow" style="margin-top:10px">${pill(r.mainCat,"accent")}${pill(r.subCat)}${pill("‚≠ê "+r.difficulty,"warn")}${pill("‚è± "+(r.timeMin||0)+" min")}${pill("üçΩ "+(r.servings||1))}</div>
<div class="smallRow" style="margin-top:10px">${pill("üî• "+Math.round(r.kcal||0)+" kcal")}${pill("üí™ "+fmt1(r.p||0)+" g P","ok")}${pill("üçö "+fmt1(r.c||0)+" g G")}${pill("ü•ë "+fmt1(r.f||0)+" g L")}</div>
${r.notes?`<div class="divider"></div><div class="mini"><strong>Notes</strong><br>${escapeHtml(r.notes).replaceAll("\n","<br>")}</div>`:""}</div>
<div><div class="mini"><strong>Ingr√©dients</strong></div><div style="margin-top:10px;overflow:auto"><table><thead><tr><th>Ingr√©dient</th><th>g</th><th>Note</th></tr></thead><tbody>${ingRows||`<tr><td colspan="3" class="mini">Aucun ingr√©dient</td></tr>`}</tbody></table></div>
<div class="divider"></div><div class="mini"><strong>Instructions</strong></div><div class="mini" style="line-height:1.55;margin-top:8px">${escapeHtml(r.steps||"").replaceAll("\n","<br>")||"‚Äî"}</div></div></div>`;
$("#overlayView").style.display="flex";}
function closeView(){$("#overlayView").style.display="none";currentId=null;}

// Edit mode
function isEditOn(){return localStorage.getItem("edit_mode")==="on";}
function setEditOn(on){localStorage.setItem("edit_mode",on?"on":"off");document.querySelectorAll(".adminOnly").forEach(el=>el.style.display=on?"":"none");$("#btnToggleEdit").textContent=on?"üîì √âdition active":"üîí Mode √©dition";}
setEditOn(isEditOn());

// Form
function renderFoodOptions(sel,selectedId){const opts=foods.slice().sort((a,b)=>a.name.localeCompare(b.name,"fr")).map(f=>`<option value="${escapeHtml(f.id)}" ${f.id===selectedId?"selected":""}>${escapeHtml(f.name)}</option>`).join("");sel.innerHTML=`<option value="">‚Äî Choisir ‚Äî</option>`+opts;}
function renderFormPhoto(){$("#formImgBox").innerHTML=formPhoto?`<img src="${formPhoto}">`:`<span>Photo</span>`;}
function updateMacroInputsLock(){const auto=$("#autoMacros").checked;["f_kcal","f_p","f_c","f_f"].forEach(id=>$("#"+id).disabled=auto);}
function addIngRow(ing={foodId:"",grams:"",label:"",note:""}){const tr=document.createElement("tr");tr.innerHTML=`<td><select class="foodSel"></select></td><td><input class="grams" type="number" min="0" step="1" value="${escapeHtml(ing.grams)}"></td><td><input class="label" type="text" value="${escapeHtml(ing.label)}"></td><td><input class="note" type="text" value="${escapeHtml(ing.note)}"></td><td><button class="btn danger" type="button">‚Äî</button></td>`;
const sel=tr.querySelector(".foodSel");renderFoodOptions(sel,ing.foodId||"");sel.addEventListener("change",recalcFormMacros);tr.querySelector(".grams").addEventListener("input",recalcFormMacros);tr.querySelector("button").addEventListener("click",()=>{tr.remove();recalcFormMacros();});$("#ingBody").appendChild(tr);recalcFormMacros();}
function collectIngredients(){return [...$("#ingBody").querySelectorAll("tr")].map(tr=>{const foodId=tr.querySelector(".foodSel").value;const grams=Number(tr.querySelector(".grams").value||0);const label=tr.querySelector(".label").value.trim();const note=tr.querySelector(".note").value.trim();return{foodId,grams,label,note};}).filter(i=>i.foodId&&i.grams>0);}
function recalcFormMacros(){if(!$("#autoMacros").checked)return;const t=calcTotals(collectIngredients());$("#f_kcal").value=Math.round(t.kcal);$("#f_p").value=fmt1(t.p);$("#f_c").value=fmt1(t.c);$("#f_f").value=fmt1(t.f);}
function resetForm(){editId=null;formPhoto=null;$("#photo").value="";$("#autoMacros").checked=true;$("#f_name").value="";$("#f_mainCat").value=MAIN_CATS[0];$("#f_subCat").value="Plat";$("#f_diff").value="Facile";$("#f_time").value="";$("#f_serv").value="1";$("#f_notes").value="";$("#f_steps").value="";["f_kcal","f_p","f_c","f_f"].forEach(id=>$("#"+id).value="");$("#ingBody").innerHTML="";addIngRow();addIngRow();updateMacroInputsLock();renderFormPhoto();recalcFormMacros();}
function openFormNew(){$("#formTitle").textContent="Nouvelle recette";resetForm();$("#overlayForm").style.display="flex";}
function openFormEdit(id){const r=state.recipes.find(x=>x.id===id);if(!r)return;if(!confirm("Modifier cette recette ?"))return;editId=id;formPhoto=r.photo||null;$("#formTitle").textContent="Modifier";$("#autoMacros").checked=(r.autoMacros!==false);$("#f_name").value=r.name||"";$("#f_mainCat").value=r.mainCat||MAIN_CATS[0];$("#f_subCat").value=r.subCat||"Plat";$("#f_diff").value=r.difficulty||"Facile";$("#f_time").value=r.timeMin||0;$("#f_serv").value=r.servings||1;$("#f_kcal").value=r.kcal||0;$("#f_p").value=r.p||0;$("#f_c").value=r.c||0;$("#f_f").value=r.f||0;$("#f_notes").value=r.notes||"";$("#f_steps").value=r.steps||"";$("#ingBody").innerHTML="";(r.ingredients||[]).forEach(i=>addIngRow(i));if(!(r.ingredients||[]).length)addIngRow();updateMacroInputsLock();renderFormPhoto();recalcFormMacros();$("#overlayForm").style.display="flex";}
function closeForm(){$("#overlayForm").style.display="none";}
function saveRecipe(){const name=$("#f_name").value.trim();if(!name){alert("Titre manquant.");return;}const auto=$("#autoMacros").checked;const ingredients=collectIngredients();let kcal=Number($("#f_kcal").value||0),p=Number($("#f_p").value||0),c=Number($("#f_c").value||0),f=Number($("#f_f").value||0);if(auto){const t=calcTotals(ingredients);kcal=Math.round(t.kcal);p=Math.round(t.p*10)/10;c=Math.round(t.c*10)/10;f=Math.round(t.f*10)/10;}
const obj={id:editId||uid(),name,mainCat:$("#f_mainCat").value,subCat:$("#f_subCat").value,difficulty:$("#f_diff").value,timeMin:Number($("#f_time").value||0),servings:Number($("#f_serv").value||1),kcal,p,c,f,autoMacros:auto,photo:formPhoto,ingredients,steps:$("#f_steps").value.trim(),notes:$("#f_notes").value.trim(),updatedAt:Date.now(),createdAt:Date.now()};
if(editId){const idx=state.recipes.findIndex(r=>r.id===editId);if(idx>=0){obj.createdAt=state.recipes[idx].createdAt||obj.createdAt;state.recipes[idx]=obj;}showToast("Modifi√©e");}else{state.recipes.unshift(obj);showToast("Ajout√©e");}saveState();closeForm();setView("recipes");renderRecipes();openRecipe(obj.id);}
function deleteCurrent(){if(!currentId)return;const r=state.recipes.find(x=>x.id===currentId);if(!r)return;if(!confirm(`Supprimer "${r.name}" ?`))return;state.recipes=state.recipes.filter(x=>x.id!==currentId);saveState();closeView();renderHome();renderRecipes();showToast("Supprim√©e");}

// Import UI
let lastUnknown=[];
function openImport(){$("#importText").value="";$("#importUnknown").textContent="‚Äî";lastUnknown=[];$("#overlayImport").style.display="flex";}
function closeImport(){$("#overlayImport").style.display="none";}
function previewImport(){const res=parseImportText($("#importText").value);if(!res){$("#importUnknown").textContent="‚Äî";lastUnknown=[];return;}lastUnknown=res.unknown||[];$("#importUnknown").textContent=lastUnknown.length?lastUnknown.join(" | "):"Tout est reconnu ‚úÖ";}
function doImport(){const res=parseImportText($("#importText").value);if(!res){alert("Colle une recette.");return;}const obj={id:uid(),name:res.name||"Recette import√©e",mainCat:"Healthy",subCat:"Plat",difficulty:"Facile",timeMin:0,servings:1,kcal:0,p:0,c:0,f:0,autoMacros:true,photo:null,ingredients:res.ingredients||[],steps:res.instructions||"",notes:lastUnknown.length?("‚ö†Ô∏è √Ä v√©rifier : "+lastUnknown.join(" | ")):"",updatedAt:Date.now(),createdAt:Date.now()};
const t=calcTotals(obj.ingredients);obj.kcal=Math.round(t.kcal);obj.p=Math.round(t.p*10)/10;obj.c=Math.round(t.c*10)/10;obj.f=Math.round(t.f*10)/10;state.recipes.unshift(obj);saveState();closeImport();setView("recipes");renderRecipes();openRecipe(obj.id);showToast("Import ‚úÖ");}

// Foods modal
function openFoods(){renderFoods();$("#overlayFoods").style.display="flex";}
function closeFoods(){$("#overlayFoods").style.display="none";}
function renderFoods(){const sorted=foods.slice().sort((a,b)=>a.name.localeCompare(b.name,"fr"));const rows=sorted.map(f=>`<tr><td><strong>${escapeHtml(f.name)}</strong></td><td>${f.kcal}</td><td>${f.p}</td><td>${f.c}</td><td>${f.f}</td></tr>`).join("");
$("#foodsBody").innerHTML=`<div class="mini">Base: <strong>${foods.length}</strong> aliments (par 100g). Ajouter: bouton +.</div><div style="margin-top:10px;overflow:auto"><table><thead><tr><th>Aliment</th><th>kcal</th><th>P</th><th>G</th><th>L</th></tr></thead><tbody>${rows}</tbody></table></div>`;}
function addFood(){const name=prompt("Nom de l‚Äôaliment :");if(!name)return;const kcal=Number(prompt("kcal / 100g :","0")||0);const p=Number(prompt("P / 100g :","0")||0);const c=Number(prompt("G / 100g :","0")||0);const f=Number(prompt("L / 100g :","0")||0);
const id=normalize(name).replaceAll(" ","_").slice(0,28)+"_"+Math.random().toString(16).slice(2,6);foods.push({id,name,kcal,p,c,f});saveFoods();renderFoods();showToast("Aliment ajout√©");}

// Edit mode PIN
$("#btnToggleEdit").addEventListener("click",()=>{$("#overlayPin").style.display="flex";$("#pinInput").value="";});
$("#btnClosePin").addEventListener("click",()=>{$("#overlayPin").style.display="none";});
$("#btnPinOk").addEventListener("click",()=>{if(($("#pinInput").value||"").trim()===EDIT_PIN){setEditOn(true);$("#overlayPin").style.display="none";showToast("√âdition ON");}else alert("PIN incorrect.");});
$("#btnPinOff").addEventListener("click",()=>{setEditOn(false);$("#overlayPin").style.display="none";showToast("√âdition OFF");});
$("#overlayPin").addEventListener("click",(e)=>{if(e.target.id==="overlayPin")$("#overlayPin").style.display="none";});

// Main events
document.querySelectorAll(".tab").forEach(t=>t.addEventListener("click",()=>setView(t.dataset.view)));
$("#btnNew").addEventListener("click",openFormNew);
$("#btnCloseForm").addEventListener("click",closeForm);
$("#overlayForm").addEventListener("click",(e)=>{if(e.target.id==="overlayForm")closeForm();});
$("#btnAddIng").addEventListener("click",()=>addIngRow());
$("#autoMacros").addEventListener("change",()=>{updateMacroInputsLock();recalcFormMacros();});
$("#btnSave").addEventListener("click",saveRecipe);

$("#photo").addEventListener("change",(e)=>{const file=e.target.files?.[0];if(!file)return;if(file.size>2.5*1024*1024){alert("Photo trop lourde.");e.target.value="";return;}const reader=new FileReader();reader.onload=()=>{formPhoto=reader.result;renderFormPhoto();};reader.readAsDataURL(file);});
$("#btnRemovePhoto").addEventListener("click",()=>{formPhoto=null;$("#photo").value="";renderFormPhoto();});

$("#btnOpenImport").addEventListener("click",openImport);
$("#btnCloseImport").addEventListener("click",closeImport);
$("#overlayImport").addEventListener("click",(e)=>{if(e.target.id==="overlayImport")closeImport();});
$("#importText").addEventListener("input",previewImport);
$("#btnDoImport").addEventListener("click",doImport);

$("#btnFoods").addEventListener("click",openFoods);
$("#btnCloseFoods").addEventListener("click",closeFoods);
$("#overlayFoods").addEventListener("click",(e)=>{if(e.target.id==="overlayFoods")closeFoods();});
$("#btnAddFood").addEventListener("click",addFood);

$("#btnCloseView").addEventListener("click",closeView);
$("#overlayView").addEventListener("click",(e)=>{if(e.target.id==="overlayView")closeView();});
$("#btnEdit").addEventListener("click",()=>{if(!currentId)return;closeView();openFormEdit(currentId);});
$("#btnDelete").addEventListener("click",deleteCurrent);

$("#btnReset").addEventListener("click",()=>{$("#q").value="";$("#mainCat").value="";$("#subCat").value="";$("#diff").value="";$("#sort").value="recent";renderRecipes();});
["q","mainCat","subCat","diff","sort"].forEach(id=>{$("#"+id).addEventListener("input",renderRecipes);$("#"+id).addEventListener("change",renderRecipes);});

// init
renderSelectors();setView("home");setEditOn(isEditOn());updateMacroInputsLock();renderFormPhoto();
</script>
</body>
</html>
